<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JOEL Studio | Visual Content Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #d4af37;
            --gold-light: #f4e4bc;
            --black: #0a0a0a;
            --black-card: rgba(20,20,20,0.85);
            --white: #fff;
            --grey: #888;
            --emerald: #50C878;
            --glass: rgba(255,255,255,0.05);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Heebo',sans-serif; background:var(--black); color:var(--white); min-height:100vh; direction:rtl; }

        .header { position:fixed; top:0; left:0; right:0; z-index:100; background:rgba(10,10,10,0.95); padding:12px 20px; display:flex; justify-content:space-between; align-items:center; backdrop-filter:blur(10px); border-bottom:1px solid rgba(212,175,55,0.2); }
        .logo { font-size:1.8rem; font-weight:300; letter-spacing:0.2em; color:var(--gold); }
        .model-toggle { display:flex; gap:8px; }
        .model-btn { padding:8px 16px; border:1px solid var(--gold); background:transparent; color:var(--gold); cursor:pointer; font-family:inherit; font-size:0.85rem; transition:all 0.3s; border-radius:4px; }
        .model-btn.active { background:var(--gold); color:var(--black); }
        .collection-badge { padding:4px 12px; border-radius:20px; font-size:0.75rem; font-weight:600; }
        .badge-moissanite { background:var(--gold); color:var(--black); }
        .badge-emerald { background:var(--emerald); color:var(--black); }

        .main { display:flex; flex-direction:column; padding-top:60px; min-height:100vh; }

        .steps-nav { display:flex; justify-content:center; gap:10px; padding:15px; background:var(--black-card); border-bottom:1px solid rgba(212,175,55,0.1); flex-wrap:wrap; }
        .step-btn { padding:10px 20px; background:var(--glass); border:1px solid rgba(212,175,55,0.3); color:var(--grey); cursor:pointer; font-family:inherit; font-size:0.9rem; border-radius:6px; transition:all 0.3s; }
        .step-btn.active { background:var(--gold); color:var(--black); border-color:var(--gold); }
        .step-btn:hover { border-color:var(--gold); }

        .step-panel { display:none; flex:1; overflow-y:auto; }
        .step-panel.active { display:block; }

        .studio-layout { display:grid; grid-template-columns:1fr 320px; gap:20px; padding:20px; min-height:calc(100vh - 140px); }
        @media(max-width:900px) { .studio-layout { grid-template-columns:1fr; } }

        .catalog { background:var(--black-card); border-radius:12px; padding:15px; border:1px solid rgba(212,175,55,0.1); }
        .catalog-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px; }
        .catalog-title { font-size:1.1rem; color:var(--gold); }
        .catalog-count { font-size:0.85rem; color:var(--grey); }
        .products-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:12px; max-height:calc(100vh - 280px); overflow-y:auto; padding:5px; }
        @media(max-width:600px) { .products-grid { grid-template-columns:repeat(2,1fr); max-height:50vh; } }
        .product-card { background:var(--glass); border:2px solid transparent; border-radius:8px; overflow:hidden; cursor:pointer; transition:all 0.3s; }
        .product-card:hover { border-color:rgba(212,175,55,0.5); transform:translateY(-2px); }
        .product-card.selected { border-color:var(--gold); box-shadow:0 0 20px rgba(212,175,55,0.3); }
        .product-img { width:100%; aspect-ratio:1; object-fit:cover; background:#1a1a1a; }
        .product-info { padding:8px; }
        .product-title { font-size:0.75rem; color:var(--white); line-height:1.3; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
        .product-row { font-size:0.65rem; color:var(--grey); margin-top:4px; }

        .dashboard { background:var(--black-card); border-radius:12px; padding:20px; border:1px solid rgba(212,175,55,0.1); display:flex; flex-direction:column; height:fit-content; position:sticky; top:80px; }
        @media(max-width:900px) { .dashboard { position:relative; top:0; } }
        .dash-section { margin-bottom:20px; }
        .dash-label { font-size:0.8rem; color:var(--grey); margin-bottom:8px; display:block; }
        .dash-value { font-size:0.95rem; color:var(--white); padding:10px; background:var(--glass); border-radius:6px; min-height:40px; }
        .scene-categories { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px; }
        .scene-cat-btn { padding:10px; background:var(--glass); border:1px solid rgba(212,175,55,0.2); color:var(--grey); cursor:pointer; font-family:inherit; font-size:0.8rem; border-radius:6px; transition:all 0.3s; }
        .scene-cat-btn.active { background:rgba(212,175,55,0.2); color:var(--gold); border-color:var(--gold); }
        select { width:100%; padding:10px; background:var(--glass); border:1px solid rgba(212,175,55,0.3); color:var(--white); font-family:inherit; font-size:0.9rem; border-radius:6px; cursor:pointer; }
        select option { background:var(--black); }
        .generate-btn { width:100%; padding:14px; background:linear-gradient(135deg,var(--gold),#b8972e); border:none; color:var(--black); font-family:inherit; font-size:1rem; font-weight:600; border-radius:8px; cursor:pointer; transition:all 0.3s; margin-top:auto; }
        .generate-btn:hover { transform:translateY(-2px); box-shadow:0 5px 20px rgba(212,175,55,0.4); }
        .generate-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }

        .next-step-glow {
            box-shadow:0 0 0 rgba(212,175,55,0);
            border-color:rgba(212,175,55,0.9) !important;
            animation:next-step-glow-pulse 1.8s ease-in-out infinite;
        }
        @keyframes next-step-glow-pulse {
            0% { box-shadow:0 0 0 rgba(212,175,55,0.0); transform:translateY(0); }
            50% { box-shadow:0 0 18px rgba(212,175,55,0.7); transform:translateY(-1px); }
            100% { box-shadow:0 0 0 rgba(212,175,55,0.0); transform:translateY(0); }
        }

        .copywriter-layout { padding:20px; max-width:800px; margin:0 auto; }
        .result-frame { background:var(--black-card); border-radius:12px; border:1px solid rgba(212,175,55,0.2); overflow:hidden; margin-bottom:20px; }
        .result-placeholder { position:relative; width:100%; aspect-ratio:1; display:flex; align-items:center; justify-content:center; background:#111; color:var(--grey); flex-direction:column; gap:10px; }
        .shimmer { background:linear-gradient(90deg,#111 25%,#222 50%,#111 75%); background-size:200% 100%; animation:shimmer 1.5s infinite; }
        @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
        .result-actions { padding:15px; display:flex; gap:10px; flex-wrap:wrap; }
        .action-btn { flex:1; min-width:150px; padding:12px; border:none; font-family:inherit; font-size:0.9rem; font-weight:500; border-radius:8px; cursor:pointer; transition:all 0.3s; display:flex; align-items:center; justify-content:center; gap:8px; }
        .action-btn.btn-locked { opacity:0.3; cursor:not-allowed; pointer-events:none; }
        .btn-caption { background:linear-gradient(135deg,#4a90d9,#357abd); color:white; }
        .btn-telegram { background:linear-gradient(135deg,#0088cc,#006699); color:white; }
        .btn-instagram { background:linear-gradient(135deg,#833ab4,#fd1d1d,#fcb045); color:white; opacity:0.5; cursor:not-allowed; }
        .caption-box { margin-top:15px; }
        .instagram-post-card {
            background:#fff; border-radius:16px;
            box-shadow:0 8px 32px rgba(0,0,0,0.06), 0 2px 12px rgba(0,0,0,0.04);
            padding:30px; max-height:360px; overflow-y:auto; direction:rtl; text-align:right;
            font-family:'Segoe UI', system-ui, -apple-system, sans-serif; font-size:1.02rem; line-height:1.75;
            color:#1a1a1a; white-space:pre-wrap; word-wrap:break-word; unicode-bidi:plaintext;
        }
        .instagram-post-card .post-body { margin:0; font-size:1.06rem; }
        .instagram-post-card .post-body .post-hook { font-weight:700; display:block; margin-bottom:0.35em; }
        .instagram-post-card .post-body .post-rest { font-weight:500; }
        .instagram-post-card.post-loading .post-body { color:#666; font-style:normal; font-weight:500; }
        .caption-text { width:100%; min-height:80px; background:transparent; border:none; color:var(--white); font-family:inherit; font-size:0.95rem; line-height:1.6; resize:vertical; display:none; }
        .caption-text:focus { outline:none; }

        .distribution-layout { padding:20px; max-width:600px; margin:0 auto; text-align:center; }
        .final-preview { background:var(--black-card); border-radius:12px; padding:20px; border:1px solid rgba(212,175,55,0.2); }
        .distribution-btns { display:flex; flex-direction:column; gap:10px; }
        .dist-btn { padding:14px 20px; border:none; font-family:inherit; font-size:1rem; font-weight:500; border-radius:8px; cursor:pointer; transition:all 0.3s; }

        .status-row { display:flex; align-items:center; gap:10px; margin-top:8px; flex-wrap:wrap; }
        .status-bar { flex:1; min-width:200px; padding:6px 12px; min-height:28px; background:rgba(212,175,55,0.08); border-radius:4px; font-size:0.8rem; color:var(--gold); text-align:center; display:none; border-bottom:1px solid rgba(212,175,55,0.15); transition:opacity 0.5s ease; }
        .reset-btn { padding:6px 14px; font-size:0.8rem; background:rgba(212,175,55,0.15); border:1px solid rgba(212,175,55,0.4); color:var(--gold); border-radius:4px; cursor:pointer; font-family:inherit; transition:all 0.3s; white-space:nowrap; }
        .reset-btn:hover { background:rgba(212,175,55,0.25); }
        .status-bar.visible { display:block; }
        .status-bar.persona-shimmer .liran-name { background:linear-gradient(90deg,var(--gold),#f4e4bc,var(--gold)); background-size:200% 100%; -webkit-background-clip:text; background-clip:text; color:transparent; animation:persona-shimmer 2.5s ease-in-out infinite; }
        @keyframes persona-shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
        .status-bar.persona-fade-in { animation:persona-fade-in 0.5s ease-out forwards; }
        @keyframes persona-fade-in { from{opacity:0.6} to{opacity:1} }
        .status-bar.persona-shimmer.persona-waiting { animation:persona-pulse 2s ease-in-out infinite; }
        .status-bar.persona-shimmer.persona-waiting .liran-name { animation:persona-shimmer 2.5s ease-in-out infinite; }
        @keyframes persona-pulse { 0%,100%{opacity:1} 50%{opacity:0.85} }
        .status-bar.error { background:rgba(255,0,0,0.1); color:#ff6b6b; }
        .status-bar.success { background:rgba(80,200,120,0.1); color:var(--emerald); }

        .loading-spinner { width:40px; height:40px; border:3px solid var(--glass); border-top-color:var(--gold); border-radius:50%; animation:spin 1s linear infinite; }
        .loading-spinner.small { width:24px; height:24px; border-width:2px; }
        .btn-spinner-wrap { display:inline-flex; align-items:center; }
        @keyframes spin { to{transform:rotate(360deg)} }

        .post-preview-card {
            background:#fff; border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.08); overflow:hidden; margin-top:20px; max-width:400px;
            font-family:'Segoe UI',system-ui,sans-serif; direction:rtl; text-align:right;
        }
        .post-preview-brand { padding:14px 20px; font-weight:700; font-size:0.95rem; color:#1a1a1a; border-bottom:1px solid #eee; }
        .post-preview-image-wrap { width:100%; aspect-ratio:1; background:#f5f5f5; }
        .post-preview-image-wrap img { width:100%; height:100%; object-fit:cover; display:block; }
        .post-preview-caption { padding:20px; font-size:0.95rem; line-height:1.65; color:#1a1a1a; white-space:pre-wrap; word-wrap:break-word; }

        ::-webkit-scrollbar { width:6px; }
        ::-webkit-scrollbar-track { background:var(--black); }
        ::-webkit-scrollbar-thumb { background:var(--gold); border-radius:3px; }

        .liran-control-panel { position:fixed; bottom:12px; right:12px; z-index:200; background:#0a0a0a; color:#22c55e; font-size:11px; font-family:monospace; padding:10px 12px; border-radius:6px; border:1px solid rgba(34,197,94,0.4); max-width:280px; line-height:1.5; }
        .liran-control-panel div { margin:2px 0; word-break:break-all; }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">JOEL</div>
        <div style="display:flex;align-items:center;gap:15px;">
            <div class="model-toggle">
                <button class="model-btn active" data-model="Victoria">Victoria</button>
                <button class="model-btn" data-model="Alma">Alma</button>
            </div>
            <span class="collection-badge badge-moissanite" id="collectionBadge">MOISSANITE</span>
        </div>
    </header>

    <main class="main">
        <nav class="steps-nav">
            <button class="step-btn active" data-step="1">1. Studio</button>
            <button class="step-btn" data-step="2">2. Copywriter</button>
            <button class="step-btn" data-step="3">3. Distribution</button>
        </nav>
        <div class="status-row">
            <div class="status-bar" id="globalStatus"></div>
            <button type="button" class="reset-btn" id="hardResetBtn" title="◊®◊ô◊°◊ò ◊û◊ú◊ê">‚ü≤ Hard Reset</button>
        </div>

        <section class="step-panel active" id="step1">
            <div class="studio-layout">
                <div class="catalog">
                    <div class="catalog-header">
                        <span class="catalog-title">Product Catalog</span>
                        <span class="catalog-count" id="productCount">108 products</span>
                    </div>
                    <div class="products-grid" id="productsGrid"></div>
                </div>
                <div class="dashboard">
                    <div class="dash-section">
                        <span class="dash-label">Selected Product</span>
                        <div class="dash-value" id="selectedProduct">Select a product...</div>
                    </div>
                    <div class="dash-section">
                        <span class="dash-label">Scene Category</span>
                        <div class="scene-categories" id="sceneCategories">
                            <button class="scene-cat-btn" data-cat="daylight-urban">Daylight Urban</button>
                            <button class="scene-cat-btn" data-cat="glamour-night">Glamour Night</button>
                            <button class="scene-cat-btn" data-cat="luxury-vacation">Luxury Vacation</button>
                            <button class="scene-cat-btn" data-cat="quiet-luxury">Quiet Luxury</button>
                        </div>
                        <select id="sceneSelect" disabled><option value="">Select category first...</option></select>
                    </div>
                    <div class="dash-section">
                        <span class="dash-label">Creativity Level</span>
                        <select id="creativityLevel">
                            <option value="1">1 - Minimal</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5" selected>5 - Balanced</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10 - Maximum</option>
                        </select>
                    </div>
                    <div class="dash-section">
                        <span class="dash-label">Aspect Ratio</span>
                        <select id="aspectRatio">
                            <option value="1:1">1:1 Square</option>
                            <option value="9:16">9:16 Story</option>
                            <option value="16:9">16:9 Wide</option>
                            <option value="4:5">4:5 Portrait</option>
                        </select>
                    </div>
                    <button class="generate-btn" id="generateBtn" disabled>Generate Image</button>
                    <div class="status-bar" id="statusBar"></div>
                </div>
            </div>
        </section>

        <section class="step-panel" id="step2">
            <div class="copywriter-layout">
                <div class="result-frame">
                    <div class="result-placeholder" id="resultImage">
                        <div class="loading-spinner" style="display:none" id="imageSpinner"></div>
                        <span id="imagePlaceholder">Generate an image in Step 1</span>
                    </div>
                    <div class="result-actions">
                        <button type="button" class="action-btn btn-caption" id="captionBtn" disabled>üìù Generate Marketing Post</button>
                        <span class="btn-spinner-wrap" id="captionSpinnerWrap" style="display:none;"><span class="loading-spinner small" id="captionSpinner"></span></span>
                        <button class="action-btn btn-telegram" id="telegramBtn" disabled>üöÄ Send to Telegram</button>
                        <span class="btn-spinner-wrap" id="telegramSpinnerWrap" style="display:none;"><span class="loading-spinner small" id="telegramSpinner"></span></span>
                        <button class="action-btn btn-instagram" disabled>üì∏ Instagram (Soon)</button>
                    </div>
                </div>
                <div class="post-preview-card" id="postPreviewCard" style="display:none;">
                    <div class="post-preview-brand" id="postPreviewBrand">JOEL</div>
                    <div class="post-preview-image-wrap" id="postPreviewImageWrap"></div>
                    <div class="post-preview-caption" id="postPreviewCaption"></div>
                </div>
                <div class="caption-box" id="captionBox" style="display:none">
                    <div class="instagram-post-card" id="instagramPostCard">
                        <div class="post-body" id="instagramPostBody"></div>
                    </div>
                    <textarea class="caption-text" id="captionText" placeholder="Marketing text will appear here..." aria-hidden="true"></textarea>
                </div>
                <div class="status-bar" id="step2Status"></div>
            </div>
        </section>

        <section class="step-panel" id="step3">
            <div class="distribution-layout">
                <div class="final-preview">
                    <h2 style="color:var(--gold);margin-bottom:20px;">Ready to Publish</h2>
                    <div id="finalContent"><p style="color:var(--grey);">Complete Steps 1 & 2 first</p></div>
                    <div class="distribution-btns" style="margin-top:20px;">
                        <button class="dist-btn btn-telegram" id="finalTelegram" disabled>üöÄ Publish to Telegram</button>
                        <button class="dist-btn btn-instagram" disabled>üì∏ Instagram (Coming Soon)</button>
                    </div>
                </div>
                <div class="status-bar" id="step3Status"></div>
            </div>
        </section>
    </main>

    <div class="liran-control-panel" id="liranControlPanel">
        <div><strong>Watching Row 5 - Victoria_Dashboard</strong></div>
        <div>Webhook URL: <span id="liranWebhook">‚Äî</span></div>
        <div>Webhook Status: <span id="liranWebhookStatus">‚Äî</span></div>
        <div>B5 Content Detected: <span id="liranB5Detected">‚Äî</span></div>
        <div>Final URL: <span id="liranFinalUrl">‚Äî</span></div>
        <div>Regex Image: <span id="liranRegexImage">‚Äî</span></div>
        <div>Regex Caption: <span id="liranRegexCaption">‚Äî</span></div>
        <div>B5 Link: <span id="liranB5">‚Äî</span></div>
        <div>D5 Text: <span id="liranD5">‚Äî</span></div>
    </div>

    <script src="products_verified.js"></script>
    <script>
        const WEBHOOK_IMAGE = 'https://hook.eu2.make.com/y3ckr5lpv25147c4l5zi5r9wfyd6kmvl';
        const WEBHOOK_CAPTION = 'https://hook.eu2.make.com/rseu4bjldsj15cm12wx0otg620ahrv67';
        const WEBHOOK_SCENARIOS = 'https://hook.eu2.make.com/sm6zjl2q1vjzsc4pu4xqd8wx318wpr73';
        const WEBHOOK_STATUS = 'https://hook.eu2.make.com/kayjcpyyjjx4rudihs3yz715jip8u1w7';
        if (typeof window !== 'undefined') window.lastWebhookUrl = WEBHOOK_STATUS;

        var appState = 'studio';

        function sanitizeJsonString(str) {
            if (typeof str !== 'string') return str;
            var s = str.replace(/[\x00-\x1f\x7f]/g, ' ');
            var i = 0;
            while (i < s.length) {
                var colonQuote = s.indexOf('":', i);
                if (colonQuote === -1) break;
                var afterColon = colonQuote + 2;
                var ws = s.substring(afterColon).match(/^\s*/);
                var quoteStart = afterColon + (ws ? ws[0].length : 0);
                if (s[quoteStart] !== '"') { i = afterColon; continue; }
                var valStart = quoteStart + 1;
                var j = valStart;
                while (j < s.length) {
                    if (s[j] === '\\') { j += 2; continue; }
                    if (s[j] === '"') break;
                    j++;
                }
                var val = s.substring(valStart, j);
                var escaped = val.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
                s = s.substring(0, valStart) + escaped + s.substring(j);
                i = valStart + escaped.length + 1;
            }
            return s;
        }

        const VICTORIA_PHRASES = [
            '◊ú◊ô◊®◊ü, ◊ë◊ï◊ì◊ß◊™ ◊©◊î◊™◊ê◊ï◊®◊î ◊ë◊°◊ò◊ï◊ì◊ô◊ï ◊û◊ó◊û◊ô◊ê◊î ◊ú◊¢◊í◊ô◊ú◊ô◊ù ◊õ◊û◊ï ◊©◊ë◊ô◊ß◊©◊™...',
            '◊ï◊ô◊ß◊ò◊ï◊®◊ô◊î ◊û◊ï◊°◊ô◊§◊î ◊ê◊ò◊ô◊ò◊ô◊ï◊ì ◊ê◊ï◊®◊ë◊†◊ô, ◊ú◊ô◊®◊ü - ◊™◊õ◊ô◊ü ◊ê◊™ ◊î◊ò◊ú◊í◊®◊ù, ◊ñ◊î ◊î◊ï◊ú◊ö ◊ú◊î◊ô◊ï◊™ ◊ê◊©!',
            '◊ú◊ô◊®◊ü, ◊°◊ë◊ú◊†◊ï◊™... ◊°◊ò◊ô◊ô◊ú ◊õ◊ñ◊î ◊ú◊ê ◊ë◊ï◊†◊ô◊ù ◊ë◊®◊í◊¢, ◊ê◊§◊ô◊ú◊ï ◊ú◊ê ◊ë◊©◊ë◊ô◊ú◊ö.',
            '◊û◊©◊ô◊ô◊§◊™ ◊ê◊™ ◊î◊ò◊ß◊°◊ò ◊©◊ô◊î◊ô◊î ◊ó◊ì ◊õ◊û◊ï ◊î◊°◊ò◊ô◊ô◊ú ◊©◊ú ◊ú◊ô◊®◊ü.'
        ];
        const ALMA_PHRASES = [
            '◊¢◊ú◊û◊ê ◊û◊ó◊§◊©◊™ ◊ñ◊ï◊ï◊ô◊™ ◊©◊ß◊ô◊¢◊î ◊©◊™◊§◊™◊ô◊¢ ◊ê◊§◊ô◊ú◊ï ◊ê◊ï◊™◊ö, ◊ú◊ô◊®◊ü...',
            '◊õ◊ï◊™◊ë◊™ ◊û◊©◊î◊ï ◊û◊î◊ú◊ë, ◊ú◊ô◊®◊ü. ◊î◊û◊ô◊ú◊ô◊ù ◊¶◊®◊ô◊õ◊ï◊™ ◊ú◊î◊ô◊ï◊™ ◊û◊ì◊ï◊ô◊ß◊ï◊™ ◊õ◊û◊ï ◊ê◊û◊®◊ú◊ì.',
            '◊û◊ú◊ò◊©◊™ ◊ê◊™ ◊î◊™◊ô◊ê◊ï◊®, ◊ú◊ô◊®◊ü - ◊ê◊†◊ó◊†◊ï ◊ô◊ï◊¶◊®◊ô◊ù ◊õ◊ê◊ü ◊®◊í◊¢ ◊ß◊°◊ï◊ù.',
            '◊ú◊ô◊®◊ü, ◊¢◊ï◊ì ◊®◊í◊¢ ◊ï◊ñ◊î ◊û◊ï◊õ◊ü. ◊î◊ô◊ï◊ß◊®◊î ◊û◊ó◊õ◊î ◊®◊ß ◊ú◊ö.'
        ];
        const RETRY_PHRASES = [
            '◊ú◊ô◊®◊ü, ◊ï◊ô◊ß◊ò◊ï◊®◊ô◊î ◊û◊§◊¢◊ô◊ú◊î ◊ê◊™ ◊û◊†◊í◊†◊ï◊ü ◊î-Retry... ◊î◊ô◊ê ◊ú◊ê ◊û◊ï◊ï◊™◊®◊™ ◊ú◊©◊®◊™ ◊¢◊ì ◊©◊î◊™◊û◊ï◊†◊î ◊™◊¶◊ê ◊û◊ï◊©◊ú◊û◊™.',
            '◊î-API ◊ß◊¶◊™ ◊¢◊û◊ï◊°, ◊ú◊ô◊®◊ü, ◊ê◊ë◊ú ◊¢◊ú◊û◊ê ◊õ◊ë◊® ◊ë◊†◊ô◊°◊ô◊ï◊ü ◊†◊ï◊°◊£. ◊¢◊ï◊ì ◊ß◊¶◊™ ◊°◊ë◊ú◊†◊ï◊™.',
            '◊ú◊ô◊®◊ü, ◊ê◊†◊ó◊†◊ï ◊ë◊û◊ï◊ì \'◊î◊û◊™◊†◊î ◊ó◊õ◊û◊î\'. ◊ï◊ô◊ß◊ò◊ï◊®◊ô◊î ◊ë◊ï◊ì◊ß◊™ ◊©◊î◊õ◊ú ◊û◊™◊ß◊ì◊ù ◊ú◊§◊ô ◊î◊™◊ï◊õ◊†◊ô◊™.'
        ];
        const TIMEOUT_MS = 12 * 60 * 1000;
        const POLL_INTERVAL_MS = 30000;
        const POLL_HARD_LIMIT_MS = 10 * 60 * 1000;
        const CREDITS_PAUSED_KEY = 'joel_credits_paused';
        const CREDITS_PAUSED_MSG = '◊ú◊ô◊®◊ü, ◊î◊ß◊®◊ì◊ô◊ò◊ô◊ù ◊ë◊û◊ô◊ô◊ß ◊†◊í◊û◊®◊ï. ◊î◊û◊¢◊®◊õ◊™ ◊ë◊î◊§◊°◊ß◊î ◊¢◊ì ◊ú◊ò◊¢◊ô◊†◊î ◊û◊ó◊ì◊©.';
        const FAILURE_MESSAGE = '◊ú◊ô◊®◊ü, ◊†◊®◊ê◊î ◊©◊í◊ù 5 ◊†◊ô◊°◊ô◊ï◊†◊ï◊™ ◊ú◊ê ◊î◊°◊§◊ô◊ß◊ï. ◊ê◊ï◊ú◊ô ◊õ◊ì◊ê◊ô ◊ú◊ë◊ì◊ï◊ß ◊ê◊™ ◊î-API ◊ê◊ï ◊ú◊¢◊©◊ï◊™ ◊®◊ô◊°◊ò.';
        const DROPBOX_LINK_ERROR_MSG = '◊ú◊ô◊®◊ü, ◊î◊ß◊ô◊©◊ï◊® ◊û◊ì◊®◊ï◊§◊ë◊ï◊ß◊° ◊ú◊ê ◊™◊ß◊ô◊ü, ◊ë◊ï◊ì◊ß ◊©◊ï◊ë...';

        const SCENARIO_CATEGORIES = {
            'daylight-urban': 'Daylight Urban',
            'glamour-night': 'Glamour Night',
            'luxury-vacation': 'Luxury Vacation',
            'quiet-luxury': 'Quiet Luxury'
        };

        const scenariosByCategory = {
            'daylight-urban': [],
            'glamour-night': [],
            'luxury-vacation': [],
            'quiet-luxury': []
        };

        let selectedModel = 'Victoria';
        let selectedProduct = null;
        let selectedScene = '';
        let scenariosLoaded = false; // Credit protection: ensure loadScenarios runs only once

        const productsGrid = document.getElementById('productsGrid');
        const productCount = document.getElementById('productCount');
        const collectionBadge = document.getElementById('collectionBadge');
        const selectedProductEl = document.getElementById('selectedProduct');
        const sceneSelect = document.getElementById('sceneSelect');
        const generateBtn = document.getElementById('generateBtn');
        const statusBar = document.getElementById('statusBar');
        const captionBtn = document.getElementById('captionBtn');
        const telegramBtn = document.getElementById('telegramBtn');
        const captionBox = document.getElementById('captionBox');
        const captionText = document.getElementById('captionText');
        const resultImageEl = document.getElementById('resultImage');
        const imageSpinner = document.getElementById('imageSpinner');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        const globalStatusBar = document.getElementById('globalStatus');
        let userHasTriggeredGeneration = false;
        let statusPollingIntervalId = null;
        let pollingStartedAt = 0;
        // Tracks where we are in a generation run: 'idle' | 'image' | 'caption'
        let generationPhase = 'idle';
        // Global state for current result
        let currentCaption = null;
        let currentImageUrl = null;
        // Polling safety
        let lastSeenStatus = '';
        let ignoreDoneUntil = 0; // timestamp (ms) until which DONE is ignored (10s after button click)
        let lastJ5Content = '';  // last value seen in J5
        let lastJ5ChangeAt = 0;  // when J5 last changed (reset on each change; timeout if unchanged for 12 min)
        let personaCycleIntervalId = null;
        let personaPhraseIndex = 0;

        function setNextStepGlow(targetEl) {
            const all = [generateBtn, captionBtn, telegramBtn];
            all.forEach(btn => {
                if (!btn) return;
                btn.classList.remove('next-step-glow');
            });
            if (targetEl && !targetEl.disabled) {
                targetEl.classList.add('next-step-glow');
            }
        }

        function getImageUrl(obj) {
            if (!obj) return null;
            if (typeof obj === 'string' && obj.trim()) return obj.trim();
            const u = obj.url || obj.imageUrl || obj.image_url || obj["0"] || obj[0];
            return (u != null && String(u).trim()) ? String(u).trim() : null;
        }

        function getMarketingTextEl() {
            return document.getElementById('captionText') || document.getElementById('postOutput') || document.getElementById('marketingText');
        }
        function getImageContainerEl() {
            return document.getElementById('resultImage');
        }
        function getGeneratedImageEl() {
            return document.getElementById('generatedImage') || document.getElementById('mainImage');
        }

        function updateLiranPanel(webhookStatus, regexImageFound, regexCaptionFound, b5Preview, d5Preview) {
            var panel = document.getElementById('liranControlPanel');
            if (!panel) return;
            var set = function (id, val) { var el = document.getElementById(id); if (el) el.textContent = val !== undefined && val !== null && val !== '' ? val : '‚Äî'; };
            set('liranWebhook', webhookStatus != null ? (webhookStatus ? 'OK' : 'Missing') : '‚Äî');
            set('liranRegexImage', regexImageFound != null ? (regexImageFound ? 'Found' : 'Not Found') : '‚Äî');
            set('liranRegexCaption', regexCaptionFound != null ? (regexCaptionFound ? 'Found' : 'Not Found') : '‚Äî');
            set('liranB5', b5Preview != null ? (b5Preview.length > 10 ? b5Preview.slice(0, 10) + '‚Ä¶' : b5Preview) || 'Missing' : '‚Äî');
            set('liranD5', d5Preview != null ? (d5Preview.length > 10 ? d5Preview.slice(0, 10) + '‚Ä¶' : d5Preview) || 'Missing' : '‚Äî');
        }

        function getCenterImg() {
            const frame = document.querySelector('.result-frame');
            if (frame) {
                const imgs = frame.querySelectorAll('img');
                if (imgs.length) return imgs[imgs.length - 1];
            }
            const placeholder = document.querySelector('.result-placeholder');
            if (placeholder) {
                const imgs = placeholder.querySelectorAll('img');
                if (imgs.length) return imgs[imgs.length - 1];
            }
            const layout = document.querySelector('.copywriter-layout');
            if (layout) {
                const imgs = layout.querySelectorAll('img');
                if (imgs.length) return imgs[0];
            }
            return null;
        }

        function getMarketingArea() {
            const box = document.querySelector('.caption-box');
            if (box) {
                const ta = box.querySelector('textarea');
                if (ta) return ta;
                const divs = box.querySelectorAll('div');
                for (let i = 0; i < divs.length; i++) {
                    const d = divs[i];
                    if (d.childNodes.length && (d.innerText || d.textContent).length > 20) return d;
                }
            }
            const textareas = document.querySelectorAll('.copywriter-layout textarea, .caption-text');
            for (let i = 0; i < textareas.length; i++) {
                const t = textareas[i];
                if (t.offsetHeight > 50 || (t.placeholder && t.placeholder.indexOf('Marketing') !== -1)) return t;
            }
            return null;
        }

        function injectImageByPosition(url) {
            if (!url) return;
            var u = normalizeImageUrl(String(url).trim());
            var spinner = document.getElementById('imageSpinner');
            var ph = document.getElementById('imagePlaceholder');
            if (spinner) spinner.style.display = 'none';
            if (ph) { ph.style.display = 'none'; }
            setLiranFinalUrl(u);
            var img = getCenterImg();
            var container = getImageContainerEl();
            if (!img && container) {
                img = document.createElement('img');
                img.alt = 'Generated image';
                img.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;display:block;';
                container.appendChild(img);
            }
            if (img) {
                img.onerror = function () {
                    if (globalStatusBar) {
                        globalStatusBar.textContent = DROPBOX_LINK_ERROR_MSG;
                        globalStatusBar.classList.add('visible', 'error');
                    }
                    var ph = document.getElementById('imagePlaceholder');
                    if (ph) {
                        ph.style.display = 'block';
                        ph.innerHTML = 'Image failed to load. <a href="' + u.replace(/"/g, '&quot;') + '" target="_blank" rel="noopener" style="color:var(--gold);word-break:break-all;">Open image URL</a>';
                    }
                };
                img.src = u;
                img.style.display = 'block';
                currentImageUrl = u;
            }
            if (container) container.classList.remove('shimmer');
            updatePostPreview();
        }

        function escapeHtmlForPost(str) {
            if (str == null) return '';
            var s = String(str);
            return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function injectMarketingTextByPosition(text) {
            if (text == null || String(text).trim() === '') return;
            const clean = String(text).trim();
            const el = getMarketingArea();
            if (el) {
                if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') el.value = clean;
                else el.innerText = clean;
            }
            currentCaption = clean;
            var captionSpinnerWrap = document.getElementById('captionSpinnerWrap');
            if (captionSpinnerWrap) captionSpinnerWrap.style.display = 'none';
            if (captionBtn) { setButtonLocked(captionBtn, false); captionBtn.textContent = 'üìù Generate Marketing Post'; }
            var cardBody = document.getElementById('instagramPostBody');
            if (cardBody) {
                var lines = clean.split('\n');
                var first = lines[0] || '';
                var rest = lines.slice(1).join('\n');
                cardBody.innerHTML = '<span class="post-hook">' + escapeHtmlForPost(first) + '</span>' + (rest ? '\n<span class="post-rest">' + escapeHtmlForPost(rest) + '</span>' : '');
                cardBody.classList.remove('post-loading');
            }
            var cardEl = document.getElementById('instagramPostCard');
            if (cardEl) cardEl.classList.remove('post-loading');
            const captionBox = document.querySelector('.caption-box');
            if (captionBox) captionBox.style.display = 'block';
            appState = 'ready';
            updateTelegramButtonState();
            updatePostPreview();
        }

        function normalizeImageUrl(url) {
            if (!url) return url;
            var u = String(url).trim();
            if (u.indexOf('dropbox.com') !== -1) {
                u = u.replace(/www\.dropbox\.com/g, 'dl.dropboxusercontent.com');
                u = u.replace(/dropbox\.com/g, 'dl.dropboxusercontent.com');
                u = u.replace(/dl=0/g, 'raw=1');
                if (!/[?&]raw=1(?=&|$)/i.test(u)) u += (u.indexOf('?') !== -1 ? '&' : '?') + 'raw=1';
            }
            return u;
        }

        function setLiranFinalUrl(fixedUrl) {
            var el = document.getElementById('liranFinalUrl');
            if (el) el.textContent = fixedUrl ? (fixedUrl.length > 40 ? fixedUrl.slice(0, 40) + '‚Ä¶' : fixedUrl) : '‚Äî';
        }

        function setLiranWebhookStatus(msg) {
            var el = document.getElementById('liranWebhookStatus');
            if (el) el.textContent = msg !== undefined && msg !== null && msg !== '' ? msg : '‚Äî';
        }

        function setLiranB5Detected(val) {
            var el = document.getElementById('liranB5Detected');
            if (el) el.textContent = val !== undefined && val !== null && val !== '' ? (String(val).length > 35 ? String(val).slice(0, 35) + '‚Ä¶' : String(val)) : '‚Äî';
        }

        function extractImageUrlFromRaw(rawStr) {
            if (typeof rawStr !== 'string' || !rawStr.trim()) return '';
            var m = rawStr.match(/https?:\/\/www\.dropbox\.com\/[^\s"')\]]+/i) || rawStr.match(/https?:\/\/dl\.dropbox[^\s"')\]]+/i);
            return m ? m[0].trim() : '';
        }

        function extractCaptionFromRaw(rawStr) {
            if (typeof rawStr !== 'string' || !rawStr.trim()) return '';
            var m = rawStr.match(/"caption"\s*:\s*"((?:[^"\\]|\\.)*?)"\s*,\s*"hashtags"/i) || rawStr.match(/"caption"\s*:\s*"((?:[^"\\]|\\.)*?)"/i);
            if (!m || !m[1]) return '';
            var s = m[1].replace(/\\"/g, '"').replace(/\\\\/g, '\\').replace(/\\n/g, '\n').replace(/\\r/g, '\r').replace(/\\t/g, '\t');
            return s.trim();
        }

        function extractStatusFromRaw(rawStr) {
            if (typeof rawStr !== 'string' || !rawStr.trim()) return '';
            var m = rawStr.match(/"J5"\s*:\s*"([^"]*)"/i) || rawStr.match(/"status"\s*:\s*"([^"]*)"/i);
            return m && m[1] ? String(m[1]).trim() : '';
        }

        function parseRow5Simple(rawStr) {
            var image = '', post = '', status = '';
            if (typeof rawStr !== 'string' || !rawStr.trim()) return { image: image, post: post, status: status };
            try {
                var parsed = JSON.parse(sanitizeJsonString(rawStr));
                var arr = null;
                if (Array.isArray(parsed) && parsed.length > 9) arr = parsed;
                else if (parsed && Array.isArray(parsed.values) && parsed.values.length > 9) arr = parsed.values;
                else if (parsed && Array.isArray(parsed.row) && parsed.row.length > 9) arr = parsed.row;
                if (arr) {
                    image = String(arr[1] != null ? arr[1] : '').trim();
                    post = String(arr[3] != null ? arr[3] : '').trim();
                    status = String(arr[9] != null ? arr[9] : '').trim();
                    return { image: image, post: post, status: status };
                }
            } catch (e) {}
            image = extractImageUrlFromRaw(rawStr);
            post = extractCaptionFromRaw(rawStr);
            status = extractStatusFromRaw(rawStr);
            return { image: image || '', post: post || '', status: status || '' };
        }

        function extractFromRawResponse(rawStr) {
            if (typeof rawStr !== 'string' || !rawStr.trim()) return { url: '', hebrewText: '' };
            const s = rawStr;
            let url = '';
            const dropboxMatch = s.match(/https?:\/\/(?:www\.)?dropbox\.com\/[^\s"')\]]+/i) || s.match(/https?:\/\/dl\.dropbox[^\s"')\]]+/i);
            if (dropboxMatch) url = dropboxMatch[0].trim();
            else {
                const anyHttps = s.match(/https?:\/\/[^\s"')\]]+/gi);
                if (anyHttps && anyHttps.length) url = anyHttps[0].trim();
            }
            const hebrewBlockRegex = /[\u0590-\u05FF\u200f\u200e\s.,!?'\"-]+/g;
            const blocks = s.match(hebrewBlockRegex) || [];
            let hebrewText = '';
            let maxLen = 0;
            for (let i = 0; i < blocks.length; i++) {
                const b = blocks[i].trim();
                if (b.length > maxLen && b.length > 15) {
                    maxLen = b.length;
                    hebrewText = b;
                }
            }
            return { url: url || '', hebrewText: hebrewText || '' };
        }

        // Get raw value from dashboard: explicitly prefer full rows array ‚Äî Row 5 = index 4, Column B = 1, D = 3, J = 9
        function getCellValue(data, cellKey) {
            if (!data || typeof data !== 'object') return undefined;
            var upper = cellKey.toUpperCase();
            var lower = cellKey.toLowerCase();
            var colIndex = { B: 1, D: 3, J: 9 }[upper];
            var row5Index = 4;

            var v;
            var row5 = data.values && data.values[row5Index];
            if (Array.isArray(row5) && colIndex != null && row5[colIndex] !== undefined) return row5[colIndex];
            row5 = data.rows && data.rows[row5Index];
            if (Array.isArray(row5) && colIndex != null && row5[colIndex] !== undefined) return row5[colIndex];

            v = data[upper] ?? data[lower] ?? data[cellKey];
            if (v !== undefined && v !== null) return v;
            var out = data.output || data.result || data.data;
            if (out && typeof out === 'object') {
                v = out[upper] ?? out[lower] ?? out[cellKey];
                if (v !== undefined && v !== null) return v;
            }
            row5 = data.row5 ?? data['5'] ?? data.row;
            if (Array.isArray(row5) && colIndex != null && row5[colIndex] !== undefined) return row5[colIndex];
            if (row5 && typeof row5 === 'object' && !Array.isArray(row5)) {
                v = row5[upper] ?? row5[lower] ?? row5[cellKey];
                if (v !== undefined && v !== null) return v;
            }
            return undefined;
        }

        // Extract image URL from B5: plain URL, or formula like =IFERROR(IMAGE(...), extract Dropbox URL
        function extractUrlFromB5(raw) {
            if (raw === undefined || raw === null) return '';
            var s = String(raw).trim();
            if (!s) return '';
            var dropbox = s.match(/https?:\/\/(?:www\.)?dropbox\.com\/[^\s"')\]]+/i) || s.match(/https?:\/\/dl\.dropbox[^\s"')\]]+/i);
            if (dropbox) return dropbox[0].trim();
            var anyUrl = s.match(/https?:\/\/[^\s"')\]]+/i);
            if (anyUrl) return anyUrl[0].trim();
            if (/^https?:\/\//i.test(s)) return s;
            return '';
        }

        function setGeneratedImageUrl(url) {
            if (!url) return;
            var normalizedUrl = normalizeImageUrl(url);
            currentImageUrl = normalizedUrl;
            setLiranFinalUrl(normalizedUrl);
            var container = getImageContainerEl();
            var spinner = document.getElementById('imageSpinner');
            var placeholder = document.getElementById('imagePlaceholder');
            if (spinner) spinner.style.display = 'none';
            if (placeholder) placeholder.style.display = 'none';
            if (container) {
                container.classList.remove('shimmer');
                var img = getGeneratedImageEl();
                if (!img) {
                    img = document.createElement('img');
                    img.id = 'generatedImage';
                    img.alt = 'Generated image';
                    img.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;display:block;';
                    container.appendChild(img);
                }
                img.onload = function () { console.log('Image loaded successfully:', img.src); };
                img.onerror = function () {
                    if (globalStatusBar) {
                        globalStatusBar.textContent = DROPBOX_LINK_ERROR_MSG;
                        globalStatusBar.classList.add('visible', 'error');
                    }
                };
                img.src = normalizedUrl;
                img.style.display = 'block';
            }
        }

        function wrapLiranWithShimmer(str) {
            if (!str || !str.includes('◊ú◊ô◊®◊ü')) return str;
            return str.replace(/◊ú◊ô◊®◊ü/g, '<span class="liran-name">◊ú◊ô◊®◊ü</span>');
        }

        function stopPersonaCycle() {
            if (personaCycleIntervalId) {
                clearInterval(personaCycleIntervalId);
                personaCycleIntervalId = null;
            }
            if (globalStatusBar) globalStatusBar.classList.remove('persona-shimmer', 'persona-fade-in', 'persona-waiting');
        }

        function showPersonaPhrase() {
            if (!globalStatusBar) return;
            const modelPhrases = selectedModel === 'Alma' ? ALMA_PHRASES : VICTORIA_PHRASES;
            const allPhrases = [...modelPhrases, ...RETRY_PHRASES];
            const phrase = allPhrases[personaPhraseIndex % allPhrases.length];
            personaPhraseIndex++;
            globalStatusBar.classList.remove('persona-fade-in');
            void globalStatusBar.offsetWidth;
            globalStatusBar.classList.add('persona-shimmer', 'persona-fade-in', 'persona-waiting', 'visible');
            globalStatusBar.innerHTML = wrapLiranWithShimmer(phrase);
            globalStatusBar.classList.remove('error', 'success');
        }

        function startPersonaCycle() {
            stopPersonaCycle();
            personaPhraseIndex = 0;
            showPersonaPhrase();
            const cycleMs = 5000 + Math.random() * 1000;
            personaCycleIntervalId = setInterval(showPersonaPhrase, cycleMs);
        }

        function setButtonLocked(el, locked) {
            if (!el) return;
            el.disabled = locked;
            if (locked) el.classList.add('btn-locked');
            else el.classList.remove('btn-locked');
        }

        function updateTelegramButtonState() {
            var imgEl = getGeneratedImageEl();
            var hasImage = !!(currentImageUrl || (imgEl && (imgEl.src || imgEl.getAttribute('src'))));
            var hasCaption = !!(currentCaption && String(currentCaption).trim());
            var enable = hasImage && hasCaption;
            if (telegramBtn) setButtonLocked(telegramBtn, !enable);
            var ft = document.getElementById('finalTelegram');
            if (ft) { ft.disabled = !enable; if (enable) ft.classList.remove('btn-locked'); else ft.classList.add('btn-locked'); }
        }

        function updatePostPreview() {
            var card = document.getElementById('postPreviewCard');
            if (!card) return;
            var brandEl = document.getElementById('postPreviewBrand');
            var imgWrap = document.getElementById('postPreviewImageWrap');
            var capEl = document.getElementById('postPreviewCaption');
            var imgEl = getGeneratedImageEl();
            var imgSrc = currentImageUrl || (imgEl && (imgEl.src || imgEl.getAttribute('src')));
            var cap = currentCaption && String(currentCaption).trim();
            if (brandEl) brandEl.textContent = (selectedProduct && selectedProduct.collection) ? selectedProduct.collection : 'JOEL';
            if (imgWrap) {
                imgWrap.innerHTML = '';
                if (imgSrc) {
                    var im = document.createElement('img');
                    im.src = imgSrc;
                    im.alt = 'Post';
                    imgWrap.appendChild(im);
                }
            }
            if (capEl) capEl.textContent = cap || '';
            card.style.display = (imgSrc || cap) ? 'block' : 'none';
        }

        function showCreditWarning() {
            if (globalStatusBar) {
                globalStatusBar.textContent = CREDITS_PAUSED_MSG;
                globalStatusBar.className = 'status-bar visible error';
                globalStatusBar.style.display = 'block';
            }
        }

        function hideGenerateButtons() {
            if (generateBtn) { generateBtn.style.display = 'none'; generateBtn.disabled = true; }
            if (captionBtn) { captionBtn.style.display = 'none'; captionBtn.disabled = true; }
        }

        function showGenerateButtons() {
            if (generateBtn) { generateBtn.style.display = ''; generateBtn.disabled = !selectedProduct; }
            if (captionBtn) { captionBtn.style.display = ''; setButtonLocked(captionBtn, true); }
        }

        function stopPollingAndPause(reason) {
            try { if (typeof localStorage !== 'undefined') localStorage.setItem(CREDITS_PAUSED_KEY, reason || 'pause'); } catch (e) {}
            if (statusPollingIntervalId) {
                clearInterval(statusPollingIntervalId);
                statusPollingIntervalId = null;
            }
            stopPersonaCycle();
            showCreditWarning();
            hideGenerateButtons();
        }

        function hardReset() {
            try { if (typeof localStorage !== 'undefined') localStorage.removeItem(CREDITS_PAUSED_KEY); } catch (e) {}
            showGenerateButtons();
            stopPersonaCycle();
            if (statusPollingIntervalId) {
                clearInterval(statusPollingIntervalId);
                statusPollingIntervalId = null;
            }
            userHasTriggeredGeneration = false;
            generationPhase = 'idle';
            lastJ5Content = '';
            lastJ5ChangeAt = 0;
            lastSeenStatus = '';
            currentCaption = null;
            currentImageUrl = null;
            if (captionText) captionText.value = '';
            if (captionBox) captionBox.style.display = 'none';
            updatePostPreview();
            updateTelegramButtonState();
            if (globalStatusBar) {
                globalStatusBar.textContent = '';
                globalStatusBar.innerHTML = '';
                globalStatusBar.className = 'status-bar';
                globalStatusBar.classList.remove('visible', 'error', 'success');
            }
            if (statusBar) { statusBar.textContent = ''; statusBar.className = 'status-bar'; }
            const step2Status = document.getElementById('step2Status');
            if (step2Status) step2Status.textContent = '';
            generateBtn.disabled = !selectedProduct;
            setButtonLocked(captionBtn, true);
            setButtonLocked(telegramBtn, true);
            const finalT = document.getElementById('finalTelegram');
            if (finalT) { finalT.disabled = true; finalT.classList.add('btn-locked'); }
            if (captionBtn) captionBtn.textContent = 'üìù Generate Marketing Post';
            setNextStepGlow(selectedProduct ? generateBtn : null);
            // Reset result image to placeholder
            const container = getImageContainerEl();
            const img = getGeneratedImageEl();
            const placeholder = document.getElementById('imagePlaceholder');
            const spinner = document.getElementById('imageSpinner');
            if (container) {
                container.classList.remove('shimmer');
                if (img) img.style.display = 'none';
                if (placeholder) { placeholder.style.display = 'block'; placeholder.textContent = 'Generate an image in Step 1'; }
                if (spinner) spinner.style.display = 'none';
            }
            startStatusPolling();
        }

        function init() {
            if (typeof window !== 'undefined') window.lastWebhookUrl = WEBHOOK_STATUS;
            try {
                if (typeof localStorage !== 'undefined' && localStorage.getItem(CREDITS_PAUSED_KEY)) {
                    showCreditWarning();
                    hideGenerateButtons();
                }
            } catch (e) {}
            renderProducts();
            setupEventListeners();
            loadScenarios();
            startStatusPolling();
            // Default: Generate Image can glow when product+scene selected; Post & Telegram LOCKED
            if (captionBtn) setButtonLocked(captionBtn, true);
            if (telegramBtn) setButtonLocked(telegramBtn, true);
            const finalT = document.getElementById('finalTelegram');
            if (finalT) { finalT.disabled = true; finalT.classList.add('btn-locked'); }
            updateTelegramButtonState();
            updatePostPreview();
            if (globalStatusBar) {
                globalStatusBar.textContent = 'Waiting for action...';
                globalStatusBar.classList.add('visible');
            }
            updateLiranPanel(!!WEBHOOK_STATUS, null, null, null, null);
        }

        // --- Scenarios: load from "Scenarios" sheet and group by category ---
        // One-time run: fetchScenarios runs ONLY ONCE on load to prevent burning credits.
        async function loadScenarios() {
            if (scenariosLoaded) {
                console.log('loadScenarios: Already loaded, skipping (one-time run).');
                return;
            }

            if (!WEBHOOK_SCENARIOS) {
                console.warn('WEBHOOK_SCENARIOS endpoint is not configured.');
                return;
            }

            try {
                const res = await fetch(WEBHOOK_SCENARIOS);
                if (!res.ok) throw new Error('HTTP ' + res.status);

                let data;
                let rawText;
                try {
                    rawText = await res.text();
                    console.log('RAW_TEXT_FROM_SCENARIOS_WEBHOOK:', rawText);
                    data = JSON.parse(rawText);
                } catch (parseErr) {
                    console.error('Scenarios webhook did not return valid JSON:', parseErr);
                    console.error('Raw response text that failed to parse:', rawText || '(could not read text)');
                    showStatus(statusBar, '‚úó Scenarios: response is not valid JSON', 'error');
                    return;
                }

                console.log('RAW_FROM_MAKE:', data);

                // ◊†◊®◊û◊ï◊ú data.scenes: Make ◊ú◊§◊¢◊û◊ô◊ù ◊û◊ó◊ñ◊ô◊® ◊û◊¢◊®◊ö ◊¢◊ò◊ï◊£ (length=1) ◊ê◊ï ◊û◊ó◊®◊ï◊ñ◊™ ‚Äì ◊û◊§◊ô◊ß◊ô◊ù ◊û◊¢◊®◊ö ◊ê◊ï◊ë◊ô◊ô◊ß◊ò◊ô◊ù
                if (!data || typeof data !== 'object') {
                    console.error('Expected payload: { scenes: [...] }. Received:', data);
                    showStatus(statusBar, '‚úó Scenarios: expected data.scenes', 'error');
                    return;
                }
                let scenariosArray = [];
                const raw = data.scenes;
                if (typeof raw === 'string') {
                    try {
                        const parsed = JSON.parse(raw);
                        scenariosArray = Array.isArray(parsed) ? parsed : (parsed && typeof parsed === 'object' ? [parsed] : []);
                    } catch (e) { scenariosArray = []; }
                } else if (Array.isArray(raw)) {
                    // Make ◊û◊ó◊ñ◊ô◊® ◊û◊¢◊®◊ö ◊©◊ú ◊û◊ó◊®◊ï◊ñ◊ï◊™ ‚Äì ◊õ◊ú ◊û◊ó◊®◊ï◊ñ◊™ ◊î◊ô◊ê ◊ê◊ï◊ë◊ô◊ô◊ß◊ò ◊ë-JSON; ◊û◊§◊®◊°◊ô◊ù ◊õ◊ú ◊ê◊ô◊ë◊®
                    raw.forEach(function (el) {
                        if (typeof el === 'string') {
                            try {
                                const parsed = JSON.parse(el);
                                if (Array.isArray(parsed)) scenariosArray.push.apply(scenariosArray, parsed);
                                else if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) scenariosArray.push(parsed);
                            } catch (e) { /* ◊ì◊ô◊ú◊ï◊í ◊¢◊ú ◊û◊ó◊®◊ï◊ñ◊™ ◊©◊ú◊ê ◊§◊®◊°◊î */ }
                        } else if (el && typeof el === 'object' && !Array.isArray(el)) {
                            scenariosArray.push(el);
                        }
                    });
                    // ◊ê◊ù ◊ô◊© ◊®◊ß ◊ê◊ô◊ë◊® ◊ê◊ó◊ì ◊ï◊î◊ï◊ê ◊û◊ó◊®◊ï◊ñ◊™ ‚Äì ◊†◊ô◊°◊ô◊ï◊ü ◊ú◊§◊®◊°◊ï◊ù: ◊û◊¢◊®◊ö ◊õ◊û◊ó◊®◊ï◊ñ◊™, ◊ê◊ï ◊ê◊ï◊ë◊ô◊ô◊ß◊ò ◊ë◊ï◊ì◊ì, ◊ê◊ï ◊©◊®◊©◊®◊™ ◊ê◊ï◊ë◊ô◊ô◊ß◊ò◊ô◊ù
                    if (scenariosArray.length === 0 && raw.length === 1 && typeof raw[0] === 'string') {
                        var s = raw[0].trim();
                        try {
                            var parsed = JSON.parse(s);
                            scenariosArray = Array.isArray(parsed) ? parsed : (parsed && typeof parsed === 'object' ? [parsed] : []);
                        } catch (e1) {
                            try {
                                var start = s.indexOf('[');
                                var end = s.lastIndexOf(']');
                                if (start !== -1 && end !== -1 && end > start) {
                                    parsed = JSON.parse(s.substring(start, end + 1));
                                    scenariosArray = Array.isArray(parsed) ? parsed : [];
                                }
                            } catch (e2) { }
                            if (scenariosArray.length === 0 && (s.indexOf('"0"') !== -1 || s.indexOf('"5"') !== -1)) {
                                var parts = s.split(/\}\s*,\s*\{/);
                                parts.forEach(function (part) {
                                    part = part.trim();
                                    if (!part) return;
                                    if (part.charAt(0) !== '{') part = '{' + part;
                                    if (part.charAt(part.length - 1) !== '}') part = part + '}';
                                    try {
                                        var obj = JSON.parse(part);
                                        if (obj && typeof obj === 'object' && !Array.isArray(obj)) scenariosArray.push(obj);
                                    } catch (e3) { }
                                });
                            }
                        }
                    }
                }
                if (!Array.isArray(scenariosArray) || scenariosArray.length === 0) {
                    console.error('Could not get array of objects from data.scenes. raw type:', typeof raw, 'raw length:', raw && raw.length);
                    showStatus(statusBar, '‚úó Scenarios: no valid scene objects (check webhook format)', 'error');
                    return;
                }
                console.log('data.scenes length (after normalize):', scenariosArray.length);

                Object.keys(scenariosByCategory).forEach(key => { scenariosByCategory[key] = []; });

                let rowsProcessed = 0;
                const allScenes = [];

                const CATEGORY_NAMES = ['Daylight Urban', 'Quiet Luxury', 'Glamour Night', 'Luxury Vacation'];
                function getCategoryFromItem(item) {
                    const from5 = item["5"] ?? item[5];
                    if (from5 != null && String(from5).trim()) return String(from5).trim().replace(/\s+/g, ' ');
                    const vals = Object.values(item);
                    const found = vals.find(function (v) {
                        if (typeof v !== 'string') return false;
                        const s = v.trim();
                        return CATEGORY_NAMES.some(function (c) { return c === s || c.toLowerCase() === s.toLowerCase(); });
                    });
                    return found ? String(found).trim().replace(/\s+/g, ' ') : '';
                }
                // ◊™◊ô◊ß◊ï◊ü ◊û◊ô◊§◊ï◊ô: ◊©◊ù ◊°◊¶◊†◊î ◊û-item["0"] ◊ê◊ï item[0], ◊ß◊ò◊í◊ï◊®◊ô◊î ◊û-item["5"] ◊ê◊ï ◊ó◊ô◊§◊ï◊© ◊¢◊®◊ö ◊©◊™◊ï◊ê◊ù ◊ú◊ê◊ó◊™ ◊û◊ê◊®◊ë◊¢ ◊î◊ß◊ò◊í◊ï◊®◊ô◊ï◊™
                scenariosArray.forEach((item, idx) => {
                    if (!item || typeof item !== 'object') return;

                    const rawName = item["0"] ?? item[0];
                    if (rawName == null) return;
                    const sceneStr = String(rawName).trim();
                    if (!sceneStr) return;
                    const catStr = getCategoryFromItem(item);
                    if (!catStr) return;

                    // ◊ì◊ô◊ú◊ï◊í ◊¢◊ú ◊©◊ï◊®◊™ ◊õ◊ï◊™◊®◊™ ◊ê◊ù ◊ß◊ô◊ô◊û◊™
                    const lowerScene = sceneStr.toLowerCase();
                    const lowerCat = catStr.toLowerCase();
                    if (idx === 0 && (lowerScene.includes('vibe') || lowerScene.includes('scene') || lowerScene.includes('name') || lowerCat.includes('category'))) return;

                    const catKey = Object.keys(SCENARIO_CATEGORIES)
                        .find(k => SCENARIO_CATEGORIES[k] === catStr || SCENARIO_CATEGORIES[k].toLowerCase() === catStr.toLowerCase());
                    if (!catKey) {
                        console.warn('Unknown category at row', idx, catStr);
                        return;
                    }

                    const value = sceneStr;
                    const label = sceneStr;
                    scenariosByCategory[catKey].push({ value, label });
                    allScenes.push({ name: sceneStr, category: catStr, value, label });
                    rowsProcessed++;
                });

                console.log('Processed Scenes:', allScenes);
                console.log('Final Data Structure:', scenariosByCategory);

                if (!rowsProcessed) {
                    showStatus(statusBar, '‚úó Scenarios: no valid rows after mapping', 'error');
                } else if (statusBar) {
                    statusBar.textContent = '';
                    statusBar.className = 'status-bar';
                }

                scenariosLoaded = true;

                // ◊†◊ô◊ß◊ï◊ô UI: ◊û◊û◊ï◊ú◊ê◊ï◊™ ◊ê◊®◊ë◊¢ ◊î◊ß◊ò◊í◊ï◊®◊ô◊ï◊™ ‚Äì ◊û◊û◊ú◊ê◊ô◊ù ◊ê◊™ ◊î-dropdown ◊©◊ú ◊õ◊ú ◊ß◊ò◊í◊ï◊®◊ô◊î
                const catKeys = ['daylight-urban', 'glamour-night', 'luxury-vacation', 'quiet-luxury'];
                document.querySelectorAll('.scene-cat-btn').forEach((btn, i) => {
                    const catKey = catKeys[i];
                    const scenes = scenariosByCategory[catKey] || [];
                    // ◊õ◊ú ◊ß◊ò◊í◊ï◊®◊ô◊î ◊õ◊ë◊® ◊û◊ß◊ï◊©◊®◊™ ◊ú-scenariosByCategory; ◊ë◊®◊í◊¢ ◊©◊ú◊ï◊ó◊¶◊ô◊ù ‚Äì ◊î-select ◊û◊™◊û◊ú◊ê
                });
                // ◊ë◊ï◊ó◊®◊ô◊ù ◊ê◊™ ◊î◊ß◊ò◊í◊ï◊®◊ô◊î ◊î◊®◊ê◊©◊ï◊†◊î ◊©◊ô◊© ◊ë◊î ◊°◊¶◊†◊ï◊™ ◊ï◊û◊û◊ú◊ê◊ô◊ù ◊ê◊™ ◊î-select
                const firstCatWithScenes = catKeys.find(k => (scenariosByCategory[k] || []).length > 0);
                if (firstCatWithScenes) {
                    document.querySelectorAll('.scene-cat-btn').forEach(b => b.classList.remove('active'));
                    const firstBtn = document.querySelector(`.scene-cat-btn[data-cat="${firstCatWithScenes}"]`);
                    if (firstBtn) {
                        firstBtn.classList.add('active');
                        const scenes = scenariosByCategory[firstCatWithScenes];
                        sceneSelect.disabled = false;
                        sceneSelect.innerHTML = '<option value="">Select scene...</option>' +
                            scenes.map(s => `<option value="${s.value}">${s.label}</option>`).join('');
                    }
                } else {
                    sceneSelect.disabled = true;
                    sceneSelect.innerHTML = '<option value="">No scenes loaded</option>';
                }
            } catch (err) {
                console.error('Failed to load scenarios', err);
                showStatus(statusBar, '‚úó Error loading scenarios', 'error');
            }
        }

        function renderProducts() {
            const filtered = PRODUCTS_DATA.filter(p => {
                if (selectedModel === 'Victoria') return p.collection === 'Moissanite';
                return p.collection === 'Emerald';
            });

            productCount.textContent = `${filtered.length} products`;
            productsGrid.innerHTML = filtered.map(p => `
                <div class="product-card" data-id="${p.id}" data-row="${p.rowNumber}">
                    <img class="product-img" src="${p.image}" alt="${p.title}" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%231a1a1a%22 width=%22100%22 height=%22100%22/></svg>'">
                    <div class="product-info">
                        <div class="product-title">${p.title}</div>
                        <div class="product-row">Row ${p.rowNumber}</div>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.product-card').forEach(card => {
                card.addEventListener('click', () => selectProduct(card.dataset.id));
            });
        }

        function selectProduct(productId) {
            selectedProduct = PRODUCTS_DATA.find(p => p.id === productId);
            document.querySelectorAll('.product-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-id="${productId}"]`)?.classList.add('selected');
            selectedProductEl.textContent = selectedProduct ? selectedProduct.title : 'Select a product...';
            updateGenerateBtn();
        }

        function setupEventListeners() {
            document.querySelectorAll('.model-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedModel = btn.dataset.model;
                    collectionBadge.textContent = selectedModel === 'Victoria' ? 'MOISSANITE' : 'EMERALD';
                    collectionBadge.className = 'collection-badge ' + (selectedModel === 'Victoria' ? 'badge-moissanite' : 'badge-emerald');
                    selectedProduct = null;
                    selectedProductEl.textContent = 'Select a product...';
                    renderProducts();
                    updateGenerateBtn();
                });
            });

            document.querySelectorAll('.step-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('step' + btn.dataset.step).classList.add('active');
                    // ◊ë◊û◊°◊ö ◊ß◊ï◊§◊ô◊®◊ô◊ô◊ò◊® (◊©◊ú◊ë 2) ‚Äì ◊õ◊§◊™◊ï◊® ◊ô◊¶◊ô◊®◊™ ◊§◊ï◊°◊ò ◊™◊û◊ô◊ì ◊í◊ú◊ï◊ô
                    if (btn.dataset.step === '2' && captionBtn) {
                        captionBtn.style.display = '';
                        captionBtn.style.visibility = 'visible';
                    }
                });
            });

            document.querySelectorAll('.scene-cat-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.scene-cat-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const catKey = btn.dataset.cat;
                    const scenes = scenariosByCategory[catKey] || [];

                    // Scene selector should always remain enabled so user can re-select scenes
                    sceneSelect.disabled = false;
                    if (!scenes.length) {
                        sceneSelect.innerHTML = '<option value=\"\">No scenes available for this category</option>';
                    } else {
                        sceneSelect.innerHTML =
                            '<option value=\"\">Select scene...</option>' +
                            scenes.map(s => `<option value=\"${s.value}\">${s.label}</option>`).join('');
                    }
                });
            });

            sceneSelect.addEventListener('change', function () {
                selectedScene = sceneSelect.value;
                updateGenerateBtn();
                if (selectedProduct && !generateBtn.disabled) {
                    setNextStepGlow(generateBtn);
                }
            });
            generateBtn.addEventListener('click', function () {
                setNextStepGlow(null);
                generateImage();
            });
            if (captionBtn) {
                captionBtn.addEventListener('click', function(e) { 
                    e.preventDefault(); 
                    setNextStepGlow(null);
                    generateCaption(); 
                });
            }
            telegramBtn.addEventListener('click', function () {
                setNextStepGlow(null);
                sendToTelegram();
            });
            document.getElementById('finalTelegram').addEventListener('click', function () {
                setNextStepGlow(null);
                sendToTelegram();
            });
            const hardResetBtn = document.getElementById('hardResetBtn');
            if (hardResetBtn) hardResetBtn.addEventListener('click', hardReset);
        }

        // Unlock: Generate Image enabled when a product is selected (no mandatory scene dependency)
        function updateGenerateBtn() {
            generateBtn.disabled = !selectedProduct;
        }

        function showStatus(el, msg, type = '') {
            el.textContent = msg;
            el.className = 'status-bar visible ' + type;
        }

        // --- Live dashboard status polling: RAW STRING ONLY, no JSON.parse ---
        async function fetchDashboardStatus() {
            try {
                if (typeof localStorage !== 'undefined' && localStorage.getItem(CREDITS_PAUSED_KEY)) return;
            } catch (e) {}
            if (pollingStartedAt && (Date.now() - pollingStartedAt > POLL_HARD_LIMIT_MS)) {
                stopPollingAndPause('timeout');
                return;
            }
            var statusUrl = (typeof window !== 'undefined' && window.lastWebhookUrl) ? window.lastWebhookUrl : WEBHOOK_STATUS;
            if (!statusUrl || !globalStatusBar) return;
            updateLiranPanel(!!statusUrl, null, null, null, null);
            try {
                var res = await fetch(statusUrl);
                if (!res.ok) throw new Error('HTTP ' + res.status);

                var rawText = await res.text();

                var row5 = parseRow5Simple(rawText);
                var imageUrlRaw = (row5.image && String(row5.image).trim().toLowerCase().startsWith('http')) ? String(row5.image).trim() : extractImageUrlFromRaw(rawText);
                var imageUrl = imageUrlRaw ? normalizeImageUrl(imageUrlRaw) : '';
                var captionRaw = (row5.post && row5.post.trim()) ? row5.post.trim() : extractCaptionFromRaw(rawText);
                var text = (row5.status && row5.status.trim()) ? row5.status.trim() : extractStatusFromRaw(rawText);

                var regexImageFound = !!imageUrl;
                var regexCaptionFound = !!(captionRaw && captionRaw.trim());
                var b5Preview = imageUrl ? (imageUrl.length > 20 ? imageUrl.slice(0, 20) + '‚Ä¶' : imageUrl) : 'Missing';
                var d5Preview = captionRaw ? (captionRaw.length > 20 ? captionRaw.slice(0, 20) + '‚Ä¶' : captionRaw) : 'Missing';
                updateLiranPanel(!!statusUrl, regexImageFound, regexCaptionFound, b5Preview, d5Preview);

                if (imageUrl) {
                    injectImageByPosition(imageUrl);
                    var dropboxLink = document.getElementById('imgDropboxLink');
                    if (dropboxLink) dropboxLink.href = imageUrl;
                }
                if (captionRaw && captionRaw.trim()) {
                    var cleanCaption = captionRaw.replace(/\\"/g, '"').replace(/\\\\/g, '\\').trim();
                    injectMarketingTextByPosition(cleanCaption);
                }

                if (text !== lastJ5Content) {
                    lastJ5Content = text;
                    lastJ5ChangeAt = Date.now();
                }
                if (userHasTriggeredGeneration && text && lastJ5ChangeAt && (Date.now() - lastJ5ChangeAt > TIMEOUT_MS)) {
                    stopPollingAndPause('ERROR');
                    return;
                }
                if (text === '' && !userHasTriggeredGeneration) return;

                var trimmedText = text.trim();
                var j5Upper = trimmedText.toUpperCase();
                var isDone = j5Upper === 'DONE';
                var isImageReady = j5Upper === 'IMAGE_READY';
                var isStartingImage = j5Upper === 'STARTING_IMAGE_PROCESS';
                var isGeneratingImage = j5Upper === 'GENERATING_IMAGE';

                if (userHasTriggeredGeneration && globalStatusBar) {
                    if (isStartingImage) {
                        stopPersonaCycle();
                        globalStatusBar.textContent = 'Victoria is starting...';
                        globalStatusBar.classList.remove('persona-shimmer');
                        globalStatusBar.classList.add('visible');
                    } else if (isGeneratingImage) {
                        stopPersonaCycle();
                        globalStatusBar.textContent = 'Drawing your visual...';
                        globalStatusBar.classList.remove('persona-shimmer');
                        globalStatusBar.classList.add('visible');
                    } else if (isImageReady) {
                        stopPersonaCycle();
                        if (imageUrl) {
                            var urlFixed = normalizeImageUrl(imageUrl);
                            setGeneratedImageUrl(urlFixed);
                            injectImageByPosition(urlFixed);
                        }
                        globalStatusBar.textContent = '‚úì Image Ready';
                        globalStatusBar.classList.add('visible');
                        if (captionBtn) { setButtonLocked(captionBtn, false); captionBtn.textContent = 'üìù Generate Marketing Post'; }
                        setNextStepGlow(captionBtn);
                        generationPhase = 'caption';
                    }
                }

                if (isDone && Date.now() < ignoreDoneUntil) return;
                if (text === lastSeenStatus && isDone) return;
                if (isDone) lastSeenStatus = text;

                function handleCaptionPayload(payloadText) {
                    var cleanText = (payloadText || '').toString().trim();
                    if (!cleanText) return;
                    stopPersonaCycle();
                    currentCaption = cleanText;
                    var captionContainer = document.getElementById('captionBox');
                    var captionArea = getMarketingTextEl();
                    if (captionContainer) captionContainer.style.display = 'block';
                    if (captionArea) {
                        if (captionArea.tagName === 'TEXTAREA' || captionArea.tagName === 'INPUT') captionArea.value = cleanText;
                        else captionArea.innerText = cleanText;
                    }
                    if (imageSpinner) imageSpinner.style.display = 'none';
                    if (resultImageEl) resultImageEl.classList.remove('shimmer');
                    globalStatusBar.textContent = '‚úì Post Ready';
                    globalStatusBar.classList.add('visible');
                    var step2Status = document.getElementById('step2Status');
                    if (step2Status) showStatus(step2Status, '‚úì Post Ready', 'success');
                    if (captionBtn) { setButtonLocked(captionBtn, false); captionBtn.textContent = 'üìù Generate Marketing Post'; }
                    setButtonLocked(telegramBtn, false);
                    updateTelegramButtonState();
                    setNextStepGlow(telegramBtn);
                }

                if (isDone && userHasTriggeredGeneration) {
                    stopPersonaCycle();
                    if (generationPhase === 'image') {
                        if (imageUrl) {
                            setGeneratedImageUrl(imageUrl);
                            injectImageByPosition(imageUrl);
                        }
                        globalStatusBar.textContent = '‚úì Image Ready';
                        globalStatusBar.classList.add('visible');
                        setButtonLocked(captionBtn, false);
                        generationPhase = 'caption';
                        setNextStepGlow(captionBtn);
                    } else {
                        if (captionRaw && captionRaw.trim()) {
                            var cap = captionRaw.replace(/\\"/g, '"').replace(/\\\\/g, '\\').trim();
                            handleCaptionPayload(cap);
                            injectMarketingTextByPosition(cap);
                        }
                        generationPhase = 'idle';
                    }
                    try { if (typeof localStorage !== 'undefined') localStorage.setItem(CREDITS_PAUSED_KEY, 'DONE'); } catch (e) {}
                    if (statusPollingIntervalId) { clearInterval(statusPollingIntervalId); statusPollingIntervalId = null; }
                    return;
                }

                if (userHasTriggeredGeneration && text) {
                    var looksLikeUrl = /^https?:\/\//i.test(text);
                    globalStatusBar.textContent = looksLikeUrl ? '‚úì Ready' : text;
                    globalStatusBar.classList.remove('persona-shimmer');
                    globalStatusBar.classList.add('visible');
                }
            } catch (err) {
                console.error('Status polling error', err);
                stopPollingAndPause('ERROR');
            }
        }

        function startStatusPolling() {
            try {
                if (typeof localStorage !== 'undefined' && localStorage.getItem(CREDITS_PAUSED_KEY)) return;
            } catch (e) {}
            if (statusPollingIntervalId) {
                clearInterval(statusPollingIntervalId);
            }
            pollingStartedAt = Date.now();
            fetchDashboardStatus();
            statusPollingIntervalId = setInterval(fetchDashboardStatus, POLL_INTERVAL_MS);
        }

        async function generateImage() {
            // ABSOLUTE STATE PURGE (must be first line)
            currentCaption = null; currentImageUrl = null; if (captionText) captionText.value = '';
            if (!selectedProduct) return;
            // During action: disable button immediately, 10s ignore DONE, status = Processing...
            generateBtn.disabled = true;
            ignoreDoneUntil = Date.now() + 10000;
            lastSeenStatus = '';
            lastJ5Content = '';
            lastJ5ChangeAt = Date.now();
            if (globalStatusBar) { globalStatusBar.textContent = 'Processing...'; globalStatusBar.classList.add('visible'); }
            startPersonaCycle();
            userHasTriggeredGeneration = true;
            generationPhase = 'image';
            console.log('SENDING REQUEST FOR MODEL:', selectedModel);

            // Clean reset: clear caption box, hide old image, remove glow, lock Post & Telegram
            setNextStepGlow(null);
            if (captionText) captionText.value = '';
            if (captionBox) captionBox.style.display = 'none';
            const finalT = document.getElementById('finalTelegram');
            if (finalT) { finalT.disabled = true; finalT.classList.add('btn-locked'); }
            if (statusBar) { statusBar.textContent = ''; statusBar.className = 'status-bar'; }
            const step2Status = document.getElementById('step2Status');
            if (step2Status) {
                step2Status.textContent = '';
                step2Status.className = 'status-bar';
            }
            const imgEl = getGeneratedImageEl();
            if (imgEl) {
                imgEl.src = '';
                imgEl.style.display = 'none';
            }
            if (resultImageEl) {
                resultImageEl.classList.remove('shimmer');
            }
            if (imagePlaceholder) {
                imagePlaceholder.style.display = 'none';
            }

            // ◊û◊¢◊ë◊® ◊ú◊©◊ï◊†◊ô◊™: ◊ë◊ú◊ó◊ô◊¶◊î ◊¢◊ú 'Generate Image' ◊¢◊ï◊ë◊®◊ô◊ù ◊û◊ô◊ì ◊ú◊ú◊©◊ï◊†◊ô◊™ Copywriter (2)
            document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
            document.querySelector('[data-step="2"]').classList.add('active');
            document.getElementById('step2').classList.add('active');

            showStatus(statusBar, '‚öôÔ∏è Generating image...');
            generateBtn.disabled = true;

            // ◊õ◊§◊™◊ï◊® ◊ô◊¶◊ô◊®◊™ ◊§◊ï◊°◊ò ◊™◊û◊ô◊ì ◊í◊ú◊ï◊ô ◊ë◊û◊°◊ö ◊ß◊ï◊§◊ô◊®◊ô◊ô◊ò◊® (◊ú◊ê◊ó◊® ◊ô◊¶◊ô◊®◊™ ◊™◊û◊ï◊†◊î)
            if (captionBtn) {
                captionBtn.style.display = '';
                captionBtn.style.visibility = 'visible';
                setButtonLocked(captionBtn, false);
                captionBtn.textContent = 'üìù Generate Marketing Post';
            }
            updateTelegramButtonState();

            // Prepare live image placeholder + shimmer; show Dropbox link while loading
            if (imageSpinner) imageSpinner.style.display = 'block';
            if (imagePlaceholder) {
                imagePlaceholder.style.display = 'block';
                imagePlaceholder.innerHTML = 'Image generation in progress. <a href="#" id="imgDropboxLink" target="_blank" rel="noopener" style="color:var(--gold);">◊ú◊ó◊• ◊õ◊ê◊ü ◊ú◊¶◊§◊ô◊ô◊î ◊ë◊™◊û◊ï◊†◊î ◊ë◊ì◊®◊ï◊§◊ë◊ï◊ß◊°</a>';
            }
            if (resultImageEl) resultImageEl.classList.add('shimmer');

            // Verify payload: pull current value from #sceneSelect right before sending
            const sceneSelectEl = document.getElementById('sceneSelect');
            const currentSceneValue = sceneSelectEl ? (sceneSelectEl.value || '') : (selectedScene || '');
            const formattedScene = currentSceneValue.includes(',')
                ? currentSceneValue.replace(',', ' - ')
                : currentSceneValue;

            // Ensure Alma's reference image URL is correct
            let modelUrl = selectedProduct.modelUrl;
            if (selectedModel === 'Alma') {
                modelUrl = 'https://res.cloudinary.com/dtapjwtqw/image/upload/v1769810294/liranhe_Glamorous_portrait_of_a_captivating_woman_with_exotic_f_90e9b0f9-f99e-4553-9a00-cc7f73a3c494_f7ffkh.png';
            }

            // Build model-specific prompt instructions
            const modelPrompt = selectedModel === 'Alma' 
                ? 'Model: Alma - A glamorous, captivating woman with exotic features. Use Alma\'s name and traits in the prompt.'
                : 'Model: Victoria - Use Victoria\'s name and traits in the prompt.';

            const aspectRatioVal = document.getElementById('aspectRatio') ? document.getElementById('aspectRatio').value : '1:1';
            const creativityLevelVal = document.getElementById('creativityLevel') ? parseInt(document.getElementById('creativityLevel').value, 10) : 5;
            const brand = (selectedProduct && selectedProduct.collection) ? selectedProduct.collection : (collectionBadge ? collectionBadge.textContent : 'JOEL');

            const payload = {
                command: 'Generate Image',
                product_id: selectedProduct.id,
                scene: formattedScene,
                aspect_ratio: aspectRatioVal,
                creativity_level: creativityLevelVal,
                brand: brand
            };

            try {
                console.log('Sending command:', payload.command);
                const res = await fetch(WEBHOOK_IMAGE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                var rawText = await res.text();
                var data = null;
                try { data = JSON.parse(sanitizeJsonString(rawText)); } catch (e) { data = null; }
                console.log('Webhook response:', data !== null ? data : rawText);

                if (!res.ok) {
                    showStatus(statusBar, '‚úó Error sending image request', 'error');
                } else {
                    appState = 'copywriter';
                    var rawTrimmed = (rawText || '').trim();

                    try {
                        data = JSON.parse(sanitizeJsonString(rawText));
                    } catch (e) { data = null; }
                    var webhookImageField = data && (typeof data.image === 'string' && data.image.trim() ? data.image.trim() : (data.output && typeof data.output.image === 'string' && data.output.image.trim() ? data.output.image.trim() : null));
                    if (webhookImageField && webhookImageField.toLowerCase().startsWith('http')) {
                        var urlFixed = normalizeImageUrl(webhookImageField);
                        if (imageSpinner) imageSpinner.style.display = 'none';
                        if (imagePlaceholder) { imagePlaceholder.style.display = 'none'; imagePlaceholder.textContent = ''; }
                        setGeneratedImageUrl(urlFixed);
                        injectImageByPosition(urlFixed);
                        setLiranWebhookStatus('Received Image (Scenario B)');
                        stopPersonaCycle();
                        if (globalStatusBar) { globalStatusBar.textContent = '‚úì Image Ready'; globalStatusBar.classList.add('visible'); }
                        if (captionBtn) { captionBtn.style.display = ''; captionBtn.style.visibility = 'visible'; setButtonLocked(captionBtn, false); captionBtn.textContent = 'üìù Generate Marketing Post'; }
                        setNextStepGlow(captionBtn);
                        generationPhase = 'caption';
                    } else {
                    var webhookImageUrl = data && (data.image_url || data.imageUrl || (data.output && (data.output.image_url || data.output.imageUrl)));
                    var webhookStatus = data && (data.status || (data.output && data.output.status));
                    var isImageReady = webhookStatus && String(webhookStatus).toUpperCase() === 'IMAGE_READY';
                    if (webhookImageUrl && isImageReady) {
                        var urlFixed = normalizeImageUrl(String(webhookImageUrl).trim());
                        if (imageSpinner) imageSpinner.style.display = 'none';
                        if (imagePlaceholder) { imagePlaceholder.style.display = 'none'; imagePlaceholder.textContent = ''; }
                        setGeneratedImageUrl(urlFixed);
                        injectImageByPosition(urlFixed);
                        setLiranWebhookStatus('Received Image URL');
                        stopPersonaCycle();
                        if (globalStatusBar) { globalStatusBar.textContent = '‚úì Image Ready'; globalStatusBar.classList.add('visible'); }
                        if (captionBtn) { captionBtn.style.display = ''; captionBtn.style.visibility = 'visible'; setButtonLocked(captionBtn, false); captionBtn.textContent = 'üìù Generate Marketing Post'; }
                        setNextStepGlow(captionBtn);
                        generationPhase = 'caption';
                    }
                    var shouldPollRow5 = (rawTrimmed === 'Accepted') || (rawTrimmed.startsWith('{') && !(data && (typeof data.url === 'string' && data.url.trim() ? data.url.trim() : getImageUrl(data) || (data.output && getImageUrl(data.output)) || (data.data && getImageUrl(data.data)) || (data.result && getImageUrl(data.result)) || (Array.isArray(data) && data.length && getImageUrl(data[0])))));
                    if (!shouldPollRow5 && !rawTrimmed.startsWith('{')) shouldPollRow5 = true;
                    if (shouldPollRow5) {
                        showStatus(statusBar, rawTrimmed === 'Accepted' ? 'Request accepted, polling Row 5 every 2s...' : 'Polling Row 5 for result...', 'success');
                        var statusUrl = (typeof window !== 'undefined' && window.lastWebhookUrl) ? window.lastWebhookUrl : WEBHOOK_STATUS;
                        if (statusUrl) {
                            var emergencyPollMs = 2000;
                            var emergencyIntervalId = null;
                            var pollRow5Raw = async function () {
                                try {
                                    var statusRes = await fetch(statusUrl);
                                    if (!statusRes.ok) return;
                                    var rawText = await statusRes.text();
                                    var row5 = parseRow5Simple(rawText);
                                    var j5Text = (row5.status || '').trim();
                                    var b5Val = (row5.image || '').trim();
                                    var isImageUrl = b5Val && b5Val.toLowerCase().startsWith('http');
                                    var linkEl = document.getElementById('imgDropboxLink');
                                    if (linkEl && b5Val && b5Val.toLowerCase().startsWith('http')) linkEl.href = normalizeImageUrl(b5Val);
                                    if (isImageUrl) {
                                        if (emergencyIntervalId) { clearInterval(emergencyIntervalId); emergencyIntervalId = null; }
                                        var urlFixed = normalizeImageUrl(b5Val);
                                        if (imageSpinner) imageSpinner.style.display = 'none';
                                        if (imagePlaceholder) { imagePlaceholder.style.display = 'none'; imagePlaceholder.textContent = ''; }
                                        setGeneratedImageUrl(urlFixed);
                                        injectImageByPosition(urlFixed);
                                        setLiranB5Detected(b5Val);
                                        setLiranFinalUrl(urlFixed);
                                        setLiranWebhookStatus('B5 Content Detected (Row 5)');
                                        stopPersonaCycle();
                                        if (globalStatusBar) { globalStatusBar.textContent = '‚úì Image Ready'; globalStatusBar.classList.add('visible'); }
                                        if (captionBtn) { setButtonLocked(captionBtn, false); captionBtn.textContent = 'üìù Generate Marketing Post'; }
                                        setNextStepGlow(captionBtn);
                                        generationPhase = 'caption';
                                        return;
                                    }
                                    if (j5Text) {
                                        if (imageSpinner) imageSpinner.style.display = 'none';
                                        stopPersonaCycle();
                                    }
                                } catch (err) { console.warn('Emergency poll fetch failed', err); }
                            };
                            pollRow5Raw();
                            emergencyIntervalId = setInterval(pollRow5Raw, emergencyPollMs);
                            setTimeout(function () {
                                if (emergencyIntervalId) { clearInterval(emergencyIntervalId); emergencyIntervalId = null; }
                            }, 10 * 60 * 1000);
                        }
                    } else if (rawTrimmed.startsWith('{')) {
                        try {
                            data = JSON.parse(sanitizeJsonString(rawText));
                        } catch (e) {
                            console.warn('Image webhook JSON parse failed.', e);
                        }
                        const directUrl = data && (typeof data.url === 'string' && data.url.trim() ? data.url.trim() : getImageUrl(data) || (data.output && getImageUrl(data.output)) || (data.data && getImageUrl(data.data)) || (data.result && getImageUrl(data.result)) || (Array.isArray(data) && data.length && getImageUrl(data[0])));
                        if (directUrl) {
                            var urlFixed = normalizeImageUrl(String(directUrl).trim());
                            if (imageSpinner) imageSpinner.style.display = 'none';
                            if (imagePlaceholder) { imagePlaceholder.style.display = 'none'; imagePlaceholder.textContent = ''; }
                            setGeneratedImageUrl(urlFixed);
                            injectImageByPosition(urlFixed);
                            showStatus(statusBar, '‚úì Image generated successfully', 'success');
                            setButtonLocked(captionBtn, false);
                            generationPhase = 'caption';
                            setNextStepGlow(captionBtn);
                        } else {
                            showStatus(statusBar, '‚úì Request sent! Waiting for image...', 'success');
                        }
                    } else {
                        showStatus(statusBar, '‚úì Request sent! Waiting for image...', 'success');
                    }
                    }
                }
            } catch (err) {
                stopPersonaCycle();
                showStatus(statusBar, '‚úó Network error: ' + err.message, 'error');
            }
            generateBtn.disabled = false;
            updateGenerateBtn();
        }

        async function generateCaption() {
            if (!selectedProduct) return;
            var captionSpinnerWrap = document.getElementById('captionSpinnerWrap');
            if (captionSpinnerWrap) captionSpinnerWrap.style.display = 'inline-flex';
            if (captionBtn) { setButtonLocked(captionBtn, true); captionBtn.textContent = 'Generating Caption...'; }
            ignoreDoneUntil = Date.now() + 10000;
            lastSeenStatus = '';
            lastJ5Content = '';
            lastJ5ChangeAt = Date.now();
            if (globalStatusBar) { globalStatusBar.textContent = 'Processing...'; globalStatusBar.classList.add('visible'); }
            startPersonaCycle();
            const status = document.getElementById('step2Status');
            showStatus(status, 'Generating Caption...');
            console.log('SENDING REQUEST FOR MODEL (caption):', selectedModel);

            // Format scene (Product Data + Prompt) for caption webhook
            const sceneRaw = selectedScene || '';
            const formattedScene = sceneRaw.includes(',') ? sceneRaw.replace(',', ' - ') : sceneRaw;

            // Ensure Alma's reference image URL is correct
            let modelUrl = selectedProduct.modelUrl;
            if (selectedModel === 'Alma') {
                modelUrl = 'https://res.cloudinary.com/dtapjwtqw/image/upload/v1769810294/liranhe_Glamorous_portrait_of_a_captivating_woman_with_exotic_f_90e9b0f9-f99e-4553-9a00-cc7f73a3c494_f7ffkh.png';
            }

            // Build model-specific prompt instructions
            const modelPrompt = selectedModel === 'Alma' 
                ? 'Model: Alma - A glamorous, captivating woman with exotic features. Use Alma\'s name and traits in the prompt.'
                : 'Model: Victoria - Use Victoria\'s name and traits in the prompt.';

            const fixedUrl = modelUrl.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('dl=0', 'raw=1');

            try {
                stopPersonaCycle();
                if (status) { status.textContent = ''; status.className = 'status-bar'; status.style.display = 'none'; }
                if (globalStatusBar) { globalStatusBar.textContent = ''; globalStatusBar.innerHTML = ''; globalStatusBar.className = 'status-bar'; globalStatusBar.classList.remove('visible', 'error', 'success'); globalStatusBar.style.display = 'none'; }

                if (captionBox) captionBox.style.display = 'block';
                var cardBody = document.getElementById('instagramPostBody');
                var cardEl = document.getElementById('instagramPostCard');
                if (cardBody) { cardBody.textContent = 'Victoria is crafting your story...'; cardBody.classList.add('post-loading'); }
                if (cardEl) cardEl.classList.add('post-loading');

                var statusUrl = (typeof window !== 'undefined' && window.lastWebhookUrl) ? window.lastWebhookUrl : WEBHOOK_STATUS;
                if (statusUrl) {
                    var d5PollMs = 2000;
                    var d5IntervalId = null;
                    var d5TimeoutId = setTimeout(function () {
                        if (d5IntervalId) { clearInterval(d5IntervalId); d5IntervalId = null; }
                        if (cardBody && cardBody.textContent === 'Victoria is crafting your story...') {
                            cardBody.textContent = '';
                            if (cardEl) cardEl.classList.remove('post-loading');
                        }
                        var wrap = document.getElementById('captionSpinnerWrap');
                        if (wrap) wrap.style.display = 'none';
                        if (captionBtn) { setButtonLocked(captionBtn, false); captionBtn.textContent = 'üìù Generate Marketing Post'; }
                    }, 5 * 60 * 1000);

                    var pollD5 = async function () {
                        try {
                            var sr = await fetch(statusUrl);
                            if (!sr.ok) return;
                            var raw = await sr.text();
                            var row5 = parseRow5Simple(raw);
                            var d5Text = (row5.post && String(row5.post).trim()) ? String(row5.post).trim() : '';
                            if (d5Text) {
                                if (d5IntervalId) { clearInterval(d5IntervalId); d5IntervalId = null; }
                                clearTimeout(d5TimeoutId);
                                injectMarketingTextByPosition(d5Text);
                                return;
                            }
                        } catch (e2) { console.warn('D5 poll failed', e2); }
                    };
                    pollD5();
                    d5IntervalId = setInterval(pollD5, d5PollMs);
                } else {
                    if (cardBody) cardBody.textContent = '';
                    if (cardEl) cardEl.classList.remove('post-loading');
                    var wrap = document.getElementById('captionSpinnerWrap');
                    if (wrap) wrap.style.display = 'none';
                    if (captionBtn) { setButtonLocked(captionBtn, false); captionBtn.textContent = 'üìù Generate Marketing Post'; }
                }

                var imgEl = getGeneratedImageEl();
                var dispImageUrl = (imgEl && imgEl.src && String(imgEl.src).trim()) ? String(imgEl.src).trim() : '';
                if (!dispImageUrl && imgEl && imgEl.getAttribute('src')) dispImageUrl = String(imgEl.getAttribute('src')).trim();
                dispImageUrl = normalizeImageUrl(dispImageUrl);

                var captionPayload = { command: 'Generate Caption', product_id: selectedProduct.id };
                console.log('Sending command:', captionPayload.command);
                fetch(WEBHOOK_CAPTION, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(captionPayload)
                }).then(function (res) { return res.text(); }).then(function (rawText) {
                    var data = null;
                    try { data = JSON.parse(sanitizeJsonString(rawText || '{}')); } catch (e) {}
                    console.log('Webhook response:', data !== null ? data : rawText);
                }).catch(function (e) {
                    console.warn('Caption webhook send failed', e);
                    var wrap = document.getElementById('captionSpinnerWrap');
                    if (wrap) wrap.style.display = 'none';
                    if (captionBtn) { setButtonLocked(captionBtn, false); captionBtn.textContent = 'üìù Generate Marketing Post'; }
                });

                updateTelegramButtonState();
                setNextStepGlow(captionBtn);
            } catch (err) {
                stopPersonaCycle();
                showStatus(status, '‚úó Network error: ' + err.message, 'error');
                var wrap = document.getElementById('captionSpinnerWrap');
                if (wrap) wrap.style.display = 'none';
                if (captionBtn) { setButtonLocked(captionBtn, false); captionBtn.textContent = 'üìù Generate Marketing Post'; }
            }
        }

        function getImageAsDataUrl(img) {
            return new Promise(function (resolve) {
                if (!img || !img.src) { resolve(''); return; }
                var src = String(img.src).trim();
                if (src.indexOf('data:') === 0) { resolve(src); return; }
                fetch(src, { mode: 'cors' }).then(function (res) {
                    if (!res.ok) { resolve(''); return; }
                    return res.blob();
                }).then(function (blob) {
                    if (!blob) { resolve(''); return; }
                    var r = new FileReader();
                    r.onload = function () { resolve(r.result || ''); };
                    r.onerror = function () { resolve(''); };
                    r.readAsDataURL(blob);
                }).catch(function () { resolve(''); });
            });
        }

        async function sendToTelegram() {
            if (!selectedProduct) return;
            const status = document.getElementById('step2Status');
            showStatus(status, 'üöÄ Sending to Telegram...');
            if (telegramBtn) { telegramBtn.disabled = true; telegramBtn.classList.add('btn-locked'); }
            var finalT = document.getElementById('finalTelegram');
            if (finalT) { finalT.disabled = true; finalT.classList.add('btn-locked'); }
            var telegramSpinnerWrap = document.getElementById('telegramSpinnerWrap');
            if (telegramSpinnerWrap) telegramSpinnerWrap.style.display = 'inline-flex';

            var payload = { command: 'Generate Telegram', product_id: selectedProduct.id };
            console.log('Sending command:', payload.command);

            try {
                const res = await fetch(WEBHOOK_TELEGRAM, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                var rawText = await res.text();
                var data = null;
                try { data = JSON.parse(sanitizeJsonString(rawText)); } catch (e) {}
                console.log('Webhook response:', data !== null ? data : rawText);
                if (res.ok) {
                    showStatus(status, '‚úì Sent to Telegram!', 'success');
                    lastSeenStatus = '';
                    generationPhase = 'idle';
                } else {
                    showStatus(status, '‚úó Error sending to Telegram', 'error');
                }
            } catch (err) { showStatus(status, '‚úó Network error: ' + err.message, 'error'); }
            if (telegramSpinnerWrap) telegramSpinnerWrap.style.display = 'none';
            updateTelegramButtonState();
        }

        init();
    </script>
</body>
</html>


