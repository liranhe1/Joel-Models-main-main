<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JOEL Studio | Visual Content Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #d4af37;
            --gold-light: #f4e4bc;
            --black: #0a0a0a;
            --black-card: rgba(20,20,20,0.85);
            --white: #fff;
            --grey: #888;
            --emerald: #50C878;
            --glass: rgba(255,255,255,0.05);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Heebo',sans-serif; background:var(--black); color:var(--white); min-height:100vh; direction:rtl; }

        .header { position:fixed; top:0; left:0; right:0; z-index:100; background:rgba(10,10,10,0.95); padding:12px 20px; display:flex; justify-content:space-between; align-items:center; backdrop-filter:blur(10px); border-bottom:1px solid rgba(212,175,55,0.2); }
        .logo { font-size:1.8rem; font-weight:300; letter-spacing:0.2em; color:var(--gold); }
        .model-toggle { display:flex; gap:8px; }
        .model-btn { padding:8px 16px; border:1px solid var(--gold); background:transparent; color:var(--gold); cursor:pointer; font-family:inherit; font-size:0.85rem; transition:all 0.3s; border-radius:4px; }
        .model-btn.active { background:var(--gold); color:var(--black); }
        .collection-badge { padding:4px 12px; border-radius:20px; font-size:0.75rem; font-weight:600; }
        .badge-moissanite { background:var(--gold); color:var(--black); }
        .badge-emerald { background:var(--emerald); color:var(--black); }

        .main { display:flex; flex-direction:column; padding-top:60px; min-height:100vh; }

        .steps-nav { display:flex; justify-content:center; gap:10px; padding:15px; background:var(--black-card); border-bottom:1px solid rgba(212,175,55,0.1); flex-wrap:wrap; }
        .step-btn { padding:10px 20px; background:var(--glass); border:1px solid rgba(212,175,55,0.3); color:var(--grey); cursor:pointer; font-family:inherit; font-size:0.9rem; border-radius:6px; transition:all 0.3s; }
        .step-btn.active { background:var(--gold); color:var(--black); border-color:var(--gold); }
        .step-btn:hover { border-color:var(--gold); }

        .step-panel { display:none; flex:1; overflow-y:auto; }
        .step-panel.active { display:block; }

        .studio-layout { display:grid; grid-template-columns:1fr 320px; gap:20px; padding:20px; min-height:calc(100vh - 140px); }
        @media(max-width:900px) { .studio-layout { grid-template-columns:1fr; } }

        .catalog { background:var(--black-card); border-radius:12px; padding:15px; border:1px solid rgba(212,175,55,0.1); }
        .catalog-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px; }
        .catalog-title { font-size:1.1rem; color:var(--gold); }
        .catalog-count { font-size:0.85rem; color:var(--grey); }
        .products-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:12px; max-height:calc(100vh - 280px); overflow-y:auto; padding:5px; }
        @media(max-width:600px) { .products-grid { grid-template-columns:repeat(2,1fr); max-height:50vh; } }
        .product-card { background:var(--glass); border:2px solid transparent; border-radius:8px; overflow:hidden; cursor:pointer; transition:all 0.3s; }
        .product-card:hover { border-color:rgba(212,175,55,0.5); transform:translateY(-2px); }
        .product-card.selected { border-color:var(--gold); box-shadow:0 0 20px rgba(212,175,55,0.3); }
        .product-img { width:100%; aspect-ratio:1; object-fit:cover; background:#1a1a1a; }
        .product-info { padding:8px; }
        .product-title { font-size:0.75rem; color:var(--white); line-height:1.3; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
        .product-row { font-size:0.65rem; color:var(--grey); margin-top:4px; }

        .dashboard { background:var(--black-card); border-radius:12px; padding:20px; border:1px solid rgba(212,175,55,0.1); display:flex; flex-direction:column; height:fit-content; position:sticky; top:80px; }
        @media(max-width:900px) { .dashboard { position:relative; top:0; } }
        .dash-section { margin-bottom:20px; }
        .dash-label { font-size:0.8rem; color:var(--grey); margin-bottom:8px; display:block; }
        .dash-value { font-size:0.95rem; color:var(--white); padding:10px; background:var(--glass); border-radius:6px; min-height:40px; }
        .scene-categories { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px; }
        .scene-cat-btn { padding:10px; background:var(--glass); border:1px solid rgba(212,175,55,0.2); color:var(--grey); cursor:pointer; font-family:inherit; font-size:0.8rem; border-radius:6px; transition:all 0.3s; }
        .scene-cat-btn.active { background:rgba(212,175,55,0.2); color:var(--gold); border-color:var(--gold); }
        select { width:100%; padding:10px; background:var(--glass); border:1px solid rgba(212,175,55,0.3); color:var(--white); font-family:inherit; font-size:0.9rem; border-radius:6px; cursor:pointer; }
        select option { background:var(--black); }
        .generate-btn { width:100%; padding:14px; background:linear-gradient(135deg,var(--gold),#b8972e); border:none; color:var(--black); font-family:inherit; font-size:1rem; font-weight:600; border-radius:8px; cursor:pointer; transition:all 0.3s; margin-top:auto; }
        .generate-btn:hover { transform:translateY(-2px); box-shadow:0 5px 20px rgba(212,175,55,0.4); }
        .generate-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }

        .copywriter-layout { padding:20px; max-width:800px; margin:0 auto; }
        .result-frame { background:var(--black-card); border-radius:12px; border:1px solid rgba(212,175,55,0.2); overflow:hidden; margin-bottom:20px; }
        .result-placeholder { position:relative; width:100%; aspect-ratio:1; display:flex; align-items:center; justify-content:center; background:#111; color:var(--grey); flex-direction:column; gap:10px; }
        .shimmer { background:linear-gradient(90deg,#111 25%,#222 50%,#111 75%); background-size:200% 100%; animation:shimmer 1.5s infinite; }
        @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
        .result-actions { padding:15px; display:flex; gap:10px; flex-wrap:wrap; }
        .action-btn { flex:1; min-width:150px; padding:12px; border:none; font-family:inherit; font-size:0.9rem; font-weight:500; border-radius:8px; cursor:pointer; transition:all 0.3s; display:flex; align-items:center; justify-content:center; gap:8px; }
        .btn-caption { background:linear-gradient(135deg,#4a90d9,#357abd); color:white; }
        .btn-telegram { background:linear-gradient(135deg,#0088cc,#006699); color:white; }
        .btn-instagram { background:linear-gradient(135deg,#833ab4,#fd1d1d,#fcb045); color:white; opacity:0.5; cursor:not-allowed; }
        .caption-box { background:var(--glass); border:1px solid rgba(212,175,55,0.2); border-radius:8px; padding:15px; margin-top:15px; }
        .caption-text { width:100%; min-height:120px; background:transparent; border:none; color:var(--white); font-family:inherit; font-size:0.95rem; line-height:1.6; resize:vertical; }
        .caption-text:focus { outline:none; }

        .distribution-layout { padding:20px; max-width:600px; margin:0 auto; text-align:center; }
        .final-preview { background:var(--black-card); border-radius:12px; padding:20px; border:1px solid rgba(212,175,55,0.2); }
        .distribution-btns { display:flex; flex-direction:column; gap:10px; }
        .dist-btn { padding:14px 20px; border:none; font-family:inherit; font-size:1rem; font-weight:500; border-radius:8px; cursor:pointer; transition:all 0.3s; }

        .status-bar { padding:10px 15px; background:rgba(212,175,55,0.1); border-radius:6px; margin-top:10px; font-size:0.85rem; color:var(--gold); text-align:center; display:none; }
        .status-bar.visible { display:block; }
        .status-bar.error { background:rgba(255,0,0,0.1); color:#ff6b6b; }
        .status-bar.success { background:rgba(80,200,120,0.1); color:var(--emerald); }

        .loading-spinner { width:40px; height:40px; border:3px solid var(--glass); border-top-color:var(--gold); border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg)} }

        ::-webkit-scrollbar { width:6px; }
        ::-webkit-scrollbar-track { background:var(--black); }
        ::-webkit-scrollbar-thumb { background:var(--gold); border-radius:3px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">JOEL</div>
        <div style="display:flex;align-items:center;gap:15px;">
            <div class="model-toggle">
                <button class="model-btn active" data-model="Victoria">Victoria</button>
                <button class="model-btn" data-model="Alma">Alma</button>
            </div>
            <span class="collection-badge badge-moissanite" id="collectionBadge">MOISSANITE</span>
        </div>
    </header>

    <main class="main">
        <nav class="steps-nav">
            <button class="step-btn active" data-step="1">1. Studio</button>
            <button class="step-btn" data-step="2">2. Copywriter</button>
            <button class="step-btn" data-step="3">3. Distribution</button>
        </nav>
        <div class="status-bar" id="globalStatus"></div>

        <section class="step-panel active" id="step1">
            <div class="studio-layout">
                <div class="catalog">
                    <div class="catalog-header">
                        <span class="catalog-title">Product Catalog</span>
                        <span class="catalog-count" id="productCount">108 products</span>
                    </div>
                    <div class="products-grid" id="productsGrid"></div>
                </div>
                <div class="dashboard">
                    <div class="dash-section">
                        <span class="dash-label">Selected Product</span>
                        <div class="dash-value" id="selectedProduct">Select a product...</div>
                    </div>
                    <div class="dash-section">
                        <span class="dash-label">Scene Category</span>
                        <div class="scene-categories" id="sceneCategories">
                            <button class="scene-cat-btn" data-cat="daylight-urban">Daylight Urban</button>
                            <button class="scene-cat-btn" data-cat="glamour-night">Glamour Night</button>
                            <button class="scene-cat-btn" data-cat="luxury-vacation">Luxury Vacation</button>
                            <button class="scene-cat-btn" data-cat="quiet-luxury">Quiet Luxury</button>
                        </div>
                        <select id="sceneSelect" disabled><option value="">Select category first...</option></select>
                    </div>
                    <div class="dash-section">
                        <span class="dash-label">Creativity Level</span>
                        <select id="creativityLevel">
                            <option value="1">1 - Minimal</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5" selected>5 - Balanced</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10 - Maximum</option>
                        </select>
                    </div>
                    <div class="dash-section">
                        <span class="dash-label">Aspect Ratio</span>
                        <select id="aspectRatio">
                            <option value="1:1">1:1 Square</option>
                            <option value="9:16">9:16 Story</option>
                            <option value="16:9">16:9 Wide</option>
                            <option value="4:5">4:5 Portrait</option>
                        </select>
                    </div>
                    <button class="generate-btn" id="generateBtn" disabled>Generate Image</button>
                    <div class="status-bar" id="statusBar"></div>
                </div>
            </div>
        </section>

        <section class="step-panel" id="step2">
            <div class="copywriter-layout">
                <div class="result-frame">
                    <div class="result-placeholder" id="resultImage">
                        <div class="loading-spinner" style="display:none" id="imageSpinner"></div>
                        <span id="imagePlaceholder">Generate an image in Step 1</span>
                    </div>
                    <div class="result-actions">
                        <button type="button" class="action-btn btn-caption" id="captionBtn" disabled>üìù Generate Marketing Post</button>
                        <button class="action-btn btn-telegram" id="telegramBtn" disabled>üöÄ Send to Telegram</button>
                        <button class="action-btn btn-instagram" disabled>üì∏ Instagram (Soon)</button>
                    </div>
                </div>
                <div class="caption-box" id="captionBox" style="display:none">
                    <textarea class="caption-text" id="captionText" placeholder="Marketing text will appear here..."></textarea>
                </div>
                <div class="status-bar" id="step2Status"></div>
            </div>
        </section>

        <section class="step-panel" id="step3">
            <div class="distribution-layout">
                <div class="final-preview">
                    <h2 style="color:var(--gold);margin-bottom:20px;">Ready to Publish</h2>
                    <div id="finalContent"><p style="color:var(--grey);">Complete Steps 1 & 2 first</p></div>
                    <div class="distribution-btns" style="margin-top:20px;">
                        <button class="dist-btn btn-telegram" id="finalTelegram" disabled>üöÄ Publish to Telegram</button>
                        <button class="dist-btn btn-instagram" disabled>üì∏ Instagram (Coming Soon)</button>
                    </div>
                </div>
                <div class="status-bar" id="step3Status"></div>
            </div>
        </section>
    </main>

    <script src="products_verified.js"></script>
    <script>
        const WEBHOOK_IMAGE = 'https://hook.eu2.make.com/y3ckr5lpv25147c4l5zi5r9wfyd6kmvl';
        const WEBHOOK_CAPTION = 'https://hook.eu2.make.com/rseu4bjldsj15cm12wx0otg620ahrv67';
        // TODO: replace these with your real webhooks/endpoints
        // that read from the "Scenarios" and "Dashboard" sheets.
        const WEBHOOK_SCENARIOS = 'https://hook.eu2.make.com/sm6zjl2q1vjzsc4pu4xqd8wx318wpr73'; // e.g. 'https://hook.eu2.make.com/your-scenarios-webhook'
        const WEBHOOK_STATUS = 'https://hook.eu2.make.com/kayjcpyyjjx4rudihs3yz715jip8u1w7';    // e.g. 'https://hook.eu2.make.com/your-dashboard-status-webhook'

        const SCENARIO_CATEGORIES = {
            'daylight-urban': 'Daylight Urban',
            'glamour-night': 'Glamour Night',
            'luxury-vacation': 'Luxury Vacation',
            'quiet-luxury': 'Quiet Luxury'
        };

        const scenariosByCategory = {
            'daylight-urban': [],
            'glamour-night': [],
            'luxury-vacation': [],
            'quiet-luxury': []
        };

        let selectedModel = 'Victoria';
        let selectedProduct = null;
        let selectedScene = '';
        let scenariosLoaded = false; // Credit protection: ensure loadScenarios runs only once

        const productsGrid = document.getElementById('productsGrid');
        const productCount = document.getElementById('productCount');
        const collectionBadge = document.getElementById('collectionBadge');
        const selectedProductEl = document.getElementById('selectedProduct');
        const sceneSelect = document.getElementById('sceneSelect');
        const generateBtn = document.getElementById('generateBtn');
        const statusBar = document.getElementById('statusBar');
        const captionBtn = document.getElementById('captionBtn');
        const telegramBtn = document.getElementById('telegramBtn');
        const captionBox = document.getElementById('captionBox');
        const captionText = document.getElementById('captionText');
        const resultImageEl = document.getElementById('resultImage');
        const imageSpinner = document.getElementById('imageSpinner');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        const globalStatusBar = document.getElementById('globalStatus');

        function init() {
            renderProducts();
            setupEventListeners();
            loadScenarios();
            startStatusPolling();
        }

        // --- Scenarios: load from "Scenarios" sheet and group by category ---
        // One-time run: fetchScenarios runs ONLY ONCE on load to prevent burning credits.
        async function loadScenarios() {
            if (scenariosLoaded) {
                console.log('loadScenarios: Already loaded, skipping (one-time run).');
                return;
            }

            if (!WEBHOOK_SCENARIOS) {
                console.warn('WEBHOOK_SCENARIOS endpoint is not configured.');
                return;
            }

            try {
                const res = await fetch(WEBHOOK_SCENARIOS);
                if (!res.ok) throw new Error('HTTP ' + res.status);

                let data;
                let rawText;
                try {
                    rawText = await res.text();
                    console.log('RAW_TEXT_FROM_SCENARIOS_WEBHOOK:', rawText);
                    data = JSON.parse(rawText);
                } catch (parseErr) {
                    console.error('Scenarios webhook did not return valid JSON:', parseErr);
                    console.error('Raw response text that failed to parse:', rawText || '(could not read text)');
                    showStatus(statusBar, '‚úó Scenarios: response is not valid JSON', 'error');
                    return;
                }

                console.log('RAW_FROM_MAKE:', data);

                // ◊†◊®◊û◊ï◊ú data.scenes: Make ◊ú◊§◊¢◊û◊ô◊ù ◊û◊ó◊ñ◊ô◊® ◊û◊¢◊®◊ö ◊¢◊ò◊ï◊£ (length=1) ◊ê◊ï ◊û◊ó◊®◊ï◊ñ◊™ ‚Äì ◊û◊§◊ô◊ß◊ô◊ù ◊û◊¢◊®◊ö ◊ê◊ï◊ë◊ô◊ô◊ß◊ò◊ô◊ù
                if (!data || typeof data !== 'object') {
                    console.error('Expected payload: { scenes: [...] }. Received:', data);
                    showStatus(statusBar, '‚úó Scenarios: expected data.scenes', 'error');
                    return;
                }
                let scenariosArray = null;
                const raw = data.scenes;
                if (typeof raw === 'string') {
                    try { scenariosArray = JSON.parse(raw); } catch (e) { scenariosArray = null; }
                } else if (Array.isArray(raw) && raw.length === 1) {
                    const first = raw[0];
                    if (typeof first === 'string') {
                        try { scenariosArray = JSON.parse(first); } catch (e1) {
                            try { scenariosArray = JSON.parse(first.trim()); } catch (e2) {
                                try { scenariosArray = JSON.parse(first.replace(/\r?\n/g, ' ')); } catch (e3) {
                                    scenariosArray = raw;
                                }
                            }
                        }
                    } else if (Array.isArray(first)) {
                        scenariosArray = first;
                    } else if (first && typeof first === 'object' && !Array.isArray(first)) {
                        scenariosArray = [first];
                    } else {
                        scenariosArray = raw;
                    }
                } else if (Array.isArray(raw)) {
                    scenariosArray = raw;
                }
                // ◊ê◊ù ◊¢◊ì◊ô◊ô◊ü ◊ô◊© ◊û◊¢◊®◊ö ◊¢◊ù ◊ê◊ú◊û◊†◊ò ◊ô◊ó◊ô◊ì ◊©◊î◊ï◊ê ◊û◊ó◊®◊ï◊ñ◊™ ‚Äì ◊†◊ô◊°◊ô◊ï◊ü ◊§◊®◊°◊ï◊ù ◊©◊†◊ô (double-encoding)
                if (Array.isArray(scenariosArray) && scenariosArray.length === 1 && typeof scenariosArray[0] === 'string') {
                    try {
                        var again = JSON.parse(scenariosArray[0]);
                        if (Array.isArray(again)) scenariosArray = again;
                    } catch (e) { /* leave as is */ }
                }
                if (!Array.isArray(scenariosArray)) {
                    console.error('Could not get array from data.scenes. raw type:', typeof raw, 'raw:', raw);
                    showStatus(statusBar, '‚úó Scenarios: invalid data.scenes format', 'error');
                    return;
                }
                // ◊ê◊ù Make ◊î◊ó◊ñ◊ô◊® ◊û◊¢◊®◊ö ◊©◊ú ◊û◊ó◊®◊ï◊ñ◊™ ◊ê◊ó◊™ (◊§◊®◊°◊ï◊ù ◊†◊õ◊©◊ú) ‚Äì ◊ú◊ê ◊†◊¢◊ë◊ì 0 ◊©◊ï◊®◊ï◊™; ◊†◊¶◊ô◊í ◊î◊ï◊ì◊¢◊î ◊ë◊®◊ï◊®◊î
                if (scenariosArray.length === 1 && typeof scenariosArray[0] === 'string') {
                    console.error('Scenarios: data.scenes is [string] ‚Äì JSON.parse failed. Ensure Make returns an array of objects, not a stringified array.');
                    showStatus(statusBar, '‚úó Scenarios: webhook must return array of objects (not string)', 'error');
                    return;
                }
                console.log('data.scenes length (after normalize):', scenariosArray.length);

                Object.keys(scenariosByCategory).forEach(key => { scenariosByCategory[key] = []; });

                let rowsProcessed = 0;
                const allScenes = [];

                // ◊™◊ô◊ß◊ï◊ü ◊û◊ô◊§◊ï◊ô: ◊©◊ù ◊°◊¶◊†◊î ◊û-item["0"] ◊ê◊ï item[0], ◊ß◊ò◊í◊ï◊®◊ô◊î ◊û-item["5"] ◊ê◊ï item[5] (◊™◊ê◊ô◊û◊ï◊™ ◊ú◊û◊§◊™◊ó◊ï◊™ ◊û◊ó◊®◊ï◊ñ◊™ ◊ï◊û◊°◊§◊®)
                scenariosArray.forEach((item, idx) => {
                    if (!item || typeof item !== 'object') return;

                    const rawName = item["0"] ?? item[0];
                    const rawCat = item["5"] ?? item[5];
                    if (rawName == null || rawCat == null) return;
                    const sceneStr = String(rawName).trim();
                    const catStr = String(rawCat).trim().replace(/\s+/g, ' ');
                    if (!sceneStr || !catStr) return;

                    // ◊ì◊ô◊ú◊ï◊í ◊¢◊ú ◊©◊ï◊®◊™ ◊õ◊ï◊™◊®◊™ ◊ê◊ù ◊ß◊ô◊ô◊û◊™
                    const lowerScene = sceneStr.toLowerCase();
                    const lowerCat = catStr.toLowerCase();
                    if (idx === 0 && (lowerScene.includes('vibe') || lowerScene.includes('scene') || lowerScene.includes('name') || lowerCat.includes('category'))) return;

                    const catKey = Object.keys(SCENARIO_CATEGORIES)
                        .find(k => SCENARIO_CATEGORIES[k] === catStr || SCENARIO_CATEGORIES[k].toLowerCase() === catStr.toLowerCase());
                    if (!catKey) {
                        console.warn('Unknown category at row', idx, catStr);
                        return;
                    }

                    const value = sceneStr;
                    const label = sceneStr;
                    scenariosByCategory[catKey].push({ value, label });
                    allScenes.push({ name: sceneStr, category: catStr, value, label });
                    rowsProcessed++;
                });

                console.log('Processed Scenes:', allScenes);
                console.log('Final Data Structure:', scenariosByCategory);

                if (!rowsProcessed) {
                    showStatus(statusBar, '‚úó Scenarios: no valid rows after mapping', 'error');
                } else if (statusBar) {
                    statusBar.textContent = '';
                    statusBar.className = 'status-bar';
                }

                scenariosLoaded = true;

                // ◊†◊ô◊ß◊ï◊ô UI: ◊û◊û◊ï◊ú◊ê◊ï◊™ ◊ê◊®◊ë◊¢ ◊î◊ß◊ò◊í◊ï◊®◊ô◊ï◊™ ‚Äì ◊û◊û◊ú◊ê◊ô◊ù ◊ê◊™ ◊î-dropdown ◊©◊ú ◊õ◊ú ◊ß◊ò◊í◊ï◊®◊ô◊î
                const catKeys = ['daylight-urban', 'glamour-night', 'luxury-vacation', 'quiet-luxury'];
                document.querySelectorAll('.scene-cat-btn').forEach((btn, i) => {
                    const catKey = catKeys[i];
                    const scenes = scenariosByCategory[catKey] || [];
                    // ◊õ◊ú ◊ß◊ò◊í◊ï◊®◊ô◊î ◊õ◊ë◊® ◊û◊ß◊ï◊©◊®◊™ ◊ú-scenariosByCategory; ◊ë◊®◊í◊¢ ◊©◊ú◊ï◊ó◊¶◊ô◊ù ‚Äì ◊î-select ◊û◊™◊û◊ú◊ê
                });
                // ◊ë◊ï◊ó◊®◊ô◊ù ◊ê◊™ ◊î◊ß◊ò◊í◊ï◊®◊ô◊î ◊î◊®◊ê◊©◊ï◊†◊î ◊©◊ô◊© ◊ë◊î ◊°◊¶◊†◊ï◊™ ◊ï◊û◊û◊ú◊ê◊ô◊ù ◊ê◊™ ◊î-select
                const firstCatWithScenes = catKeys.find(k => (scenariosByCategory[k] || []).length > 0);
                if (firstCatWithScenes) {
                    document.querySelectorAll('.scene-cat-btn').forEach(b => b.classList.remove('active'));
                    const firstBtn = document.querySelector(`.scene-cat-btn[data-cat="${firstCatWithScenes}"]`);
                    if (firstBtn) {
                        firstBtn.classList.add('active');
                        const scenes = scenariosByCategory[firstCatWithScenes];
                        sceneSelect.disabled = false;
                        sceneSelect.innerHTML = '<option value="">Select scene...</option>' +
                            scenes.map(s => `<option value="${s.value}">${s.label}</option>`).join('');
                    }
                } else {
                    sceneSelect.disabled = true;
                    sceneSelect.innerHTML = '<option value="">No scenes loaded</option>';
                }
            } catch (err) {
                console.error('Failed to load scenarios', err);
                showStatus(statusBar, '‚úó Error loading scenarios', 'error');
            }
        }

        function renderProducts() {
            const filtered = PRODUCTS_DATA.filter(p => {
                if (selectedModel === 'Victoria') return p.collection === 'Moissanite';
                return p.collection === 'Emerald';
            });

            productCount.textContent = `${filtered.length} products`;
            productsGrid.innerHTML = filtered.map(p => `
                <div class="product-card" data-id="${p.id}" data-row="${p.rowNumber}">
                    <img class="product-img" src="${p.image}" alt="${p.title}" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%231a1a1a%22 width=%22100%22 height=%22100%22/></svg>'">
                    <div class="product-info">
                        <div class="product-title">${p.title}</div>
                        <div class="product-row">Row ${p.rowNumber}</div>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.product-card').forEach(card => {
                card.addEventListener('click', () => selectProduct(card.dataset.id));
            });
        }

        function selectProduct(productId) {
            selectedProduct = PRODUCTS_DATA.find(p => p.id === productId);
            document.querySelectorAll('.product-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-id="${productId}"]`)?.classList.add('selected');
            selectedProductEl.textContent = selectedProduct ? selectedProduct.title : 'Select a product...';
            updateGenerateBtn();
        }

        function setupEventListeners() {
            document.querySelectorAll('.model-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedModel = btn.dataset.model;
                    collectionBadge.textContent = selectedModel === 'Victoria' ? 'MOISSANITE' : 'EMERALD';
                    collectionBadge.className = 'collection-badge ' + (selectedModel === 'Victoria' ? 'badge-moissanite' : 'badge-emerald');
                    selectedProduct = null;
                    selectedProductEl.textContent = 'Select a product...';
                    renderProducts();
                    updateGenerateBtn();
                });
            });

            document.querySelectorAll('.step-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('step' + btn.dataset.step).classList.add('active');
                });
            });

            document.querySelectorAll('.scene-cat-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.scene-cat-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const catKey = btn.dataset.cat;
                    const scenes = scenariosByCategory[catKey] || [];

                    if (!scenes.length) {
                        sceneSelect.disabled = true;
                        sceneSelect.innerHTML = '<option value="">No scenes available for this category</option>';
                    } else {
                        sceneSelect.disabled = false;
                        sceneSelect.innerHTML =
                            '<option value="">Select scene...</option>' +
                            scenes.map(s => `<option value="${s.value}">${s.label}</option>`).join('');
                    }
                });
            });

            sceneSelect.addEventListener('change', () => { selectedScene = sceneSelect.value; updateGenerateBtn(); });
            generateBtn.addEventListener('click', generateImage);
            if (captionBtn) {
                captionBtn.addEventListener('click', function(e) { e.preventDefault(); generateCaption(); });
            }
            telegramBtn.addEventListener('click', sendToTelegram);
            document.getElementById('finalTelegram').addEventListener('click', sendToTelegram);
        }

        // Emergency UI unlock: enable Generate even when no scenes loaded (for sync testing)
        function updateGenerateBtn() {
            const hasAnyScenes = Object.values(scenariosByCategory).some(arr => arr.length > 0);
            const needScene = hasAnyScenes ? !!selectedScene : false;
            generateBtn.disabled = !selectedProduct || needScene;
        }

        function showStatus(el, msg, type = '') {
            el.textContent = msg;
            el.className = 'status-bar visible ' + type;
        }

        // --- Live dashboard status polling (Dashboard!A2) ---
        async function fetchDashboardStatus() {
            if (!WEBHOOK_STATUS || !globalStatusBar) return;
            try {
                const res = await fetch(WEBHOOK_STATUS);
                if (!res.ok) throw new Error('HTTP ' + res.status);

                let data;
                let rawText;
                try {
                    rawText = await res.text();
                    data = JSON.parse(rawText);
                } catch (parseErr) {
                    console.error('Status webhook did not return valid JSON:', parseErr);
                    console.error('Raw response text that failed to parse:', rawText || '(could not read text)');
                    return;
                }
                // Expect backend to return the content of Dashboard!J5 (primary) or fall back to other fields
                const text =
                    data.J5 ||
                    data.j5 ||
                    data.status ||
                    data.value ||
                    data.statusText ||
                    data.A2 ||
                    '';
                if (!text) return;

                globalStatusBar.textContent = text;
                globalStatusBar.classList.add('visible');
            } catch (err) {
                console.error('Status polling error', err);
            }
        }

        function startStatusPolling() {
            fetchDashboardStatus();
            // Credit protection: all status checks (e.g. Dashboard J5) run every 25 seconds only
            setInterval(fetchDashboardStatus, 25000);
        }

        async function generateImage() {
            if (!selectedProduct) return;
            // ◊û◊¢◊ë◊® ◊ú◊©◊ï◊†◊ô◊™: ◊ë◊ú◊ó◊ô◊¶◊î ◊¢◊ú 'Generate Image' ◊¢◊ï◊ë◊®◊ô◊ù ◊û◊ô◊ì ◊ú◊ú◊©◊ï◊†◊ô◊™ Copywriter (2)
            document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
            document.querySelector('[data-step="2"]').classList.add('active');
            document.getElementById('step2').classList.add('active');

            showStatus(statusBar, '‚öôÔ∏è Generating image...');
            generateBtn.disabled = true;

            // Prepare live image placeholder + shimmer
            if (imageSpinner) imageSpinner.style.display = 'block';
            if (imagePlaceholder) {
                imagePlaceholder.style.display = 'block';
                imagePlaceholder.textContent = 'Image generation in progress...';
            }
            if (resultImageEl) resultImageEl.classList.add('shimmer');

            // Format scene (allow empty when no scenes loaded - emergency unlock for testing)
            const formattedScene = (selectedScene || '').includes(',')
                ? (selectedScene || '').replace(',', ' - ')
                : (selectedScene || '');

            // Ensure Alma's reference image URL is correct
            let modelUrl = selectedProduct.modelUrl;
            if (selectedModel === 'Alma') {
                modelUrl = 'https://res.cloudinary.com/dtapjwtqw/image/upload/v1769810294/liranhe_Glamorous_portrait_of_a_captivating_woman_with_exotic_f_90e9b0f9-f99e-4553-9a00-cc7f73a3c494_f7ffkh.png';
            }

            // Build model-specific prompt instructions
            const modelPrompt = selectedModel === 'Alma' 
                ? 'Model: Alma - A glamorous, captivating woman with exotic features. Use Alma\'s name and traits in the prompt.'
                : 'Model: Victoria - Use Victoria\'s name and traits in the prompt.';

            const payload = {
                source: 'Web_App',
                product_id: selectedProduct.id,
                rowNumber: selectedProduct.rowNumber,
                product: selectedProduct.title,
                model: selectedModel,
                collection: selectedProduct.collection,
                model_url: modelUrl,
                scene: formattedScene,
                situation: formattedScene, // Add situation field with formatted value
                aspect_ratio: document.getElementById('aspectRatio').value,
                creativity: parseInt(document.getElementById('creativityLevel').value),
                model_prompt: modelPrompt,
                scale_law: 'The jewelry must be visually reduced by 500% to stay dainty and realistic. Use delicate proportions.',
                command: 'Generate Image'
            };

            try {
                console.log('Request sent'); // Log to console when webhook is triggered
                const res = await fetch(WEBHOOK_IMAGE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    showStatus(statusBar, '‚úó Error sending image request', 'error');
                } else {
                    let data = null;
                    let rawText;
                    try {
                        rawText = await res.text();
                        console.log('RAW_TEXT_FROM_IMAGE_WEBHOOK:', rawText);
                        data = JSON.parse(rawText);
                    } catch (e) {
                        console.warn('Image webhook did not return JSON or parsing failed.', e);
                        console.error('Raw response text that failed to parse:', rawText || '(could not read text)');
                    }

                    // ◊ó◊ô◊ú◊ï◊• ◊™◊û◊ï◊†◊î: ◊û◊ï◊©◊õ◊ô◊ù ◊ê◊™ ◊î-URL ◊û◊°◊†◊®◊ô◊ï B ‚Äì ◊û◊§◊™◊ó ◊û◊°◊§◊®◊ô ◊ê◊ï ◊©◊ù ◊©◊ì◊î, ◊ï◊û◊¶◊ô◊í◊ô◊ù ◊ë-UI
                    function getImageUrl(obj) {
                        if (!obj) return null;
                        if (typeof obj === 'string' && obj.trim()) return obj.trim();
                        const u = obj.url || obj.imageUrl || obj.image_url || obj["0"] || obj[0];
                        return (u != null && String(u).trim()) ? String(u).trim() : null;
                    }
                    const finalUrl = data && (
                        getImageUrl(data) ||
                        (data.output && getImageUrl(data.output)) ||
                        (data.data && getImageUrl(data.data)) ||
                        (data.result && getImageUrl(data.result)) ||
                        (Array.isArray(data) && data.length && getImageUrl(data[0]))
                    );

                    if (finalUrl) {
                        console.log('Image URL received:', finalUrl);
                        if (resultImageEl) {
                            resultImageEl.classList.remove('shimmer');
                            if (imageSpinner) imageSpinner.style.display = 'none';
                            if (imagePlaceholder) imagePlaceholder.style.display = 'none';
                            let img = document.getElementById('generatedImage');
                            if (!img) {
                                img = document.createElement('img');
                                img.id = 'generatedImage';
                                img.alt = 'Generated image';
                                img.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;display:block;';
                                resultImageEl.appendChild(img);
                            }
                            img.src = finalUrl;
                            img.style.display = 'block';
                        }
                        showStatus(statusBar, '‚úì Image generated successfully', 'success');
                        captionBtn.disabled = false;
                        telegramBtn.disabled = false;
                        document.getElementById('finalTelegram').disabled = false;
                    } else {
                        showStatus(statusBar, '‚úì Request sent! Waiting for image...', 'success');
                    }
                }
            } catch (err) {
                showStatus(statusBar, '‚úó Network error: ' + err.message, 'error');
            }
            generateBtn.disabled = false;
            updateGenerateBtn();
        }

        async function generateCaption() {
            if (!selectedProduct) return;
            const status = document.getElementById('step2Status');
            showStatus(status, '◊ô◊ï◊¶◊® ◊ß◊§◊©◊ü...');
            captionBtn.disabled = true;

            // Format scene (Product Data + Prompt) for caption webhook
            const sceneRaw = selectedScene || '';
            const formattedScene = sceneRaw.includes(',') ? sceneRaw.replace(',', ' - ') : sceneRaw;

            // Ensure Alma's reference image URL is correct
            let modelUrl = selectedProduct.modelUrl;
            if (selectedModel === 'Alma') {
                modelUrl = 'https://res.cloudinary.com/dtapjwtqw/image/upload/v1769810294/liranhe_Glamorous_portrait_of_a_captivating_woman_with_exotic_f_90e9b0f9-f99e-4553-9a00-cc7f73a3c494_f7ffkh.png';
            }

            // Build model-specific prompt instructions
            const modelPrompt = selectedModel === 'Alma' 
                ? 'Model: Alma - A glamorous, captivating woman with exotic features. Use Alma\'s name and traits in the prompt.'
                : 'Model: Victoria - Use Victoria\'s name and traits in the prompt.';

            const fixedUrl = modelUrl.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('dl=0', 'raw=1');
                
            const payload = {
                source: 'Web_App',
                product_id: selectedProduct.id,
                rowNumber: selectedProduct.rowNumber,
                product: selectedProduct.title,
                model: selectedModel,
                collection: selectedProduct.collection,
                model_url: fixedUrl,
                scene: formattedScene,
                situation: formattedScene,
                model_prompt: modelPrompt,
                prompt: formattedScene,
                command: 'Generate Caption'
            };

            try {
                console.log('Caption request sent to', WEBHOOK_CAPTION, { product: selectedProduct.title, scene: formattedScene });
                const res = await fetch(WEBHOOK_CAPTION, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    showStatus(status, '‚úó Error generating caption', 'error');
                } else {
                    let data = null;
                    let rawText;
                    try {
                        rawText = await res.text();
                        console.log('RAW_TEXT_FROM_CAPTION_WEBHOOK:', rawText);
                        data = JSON.parse(rawText);
                    } catch (e) {
                        console.warn('Caption webhook did not return JSON or parsing failed.', e);
                        console.error('Raw response text that failed to parse:', rawText || '(could not read text)');
                    }

                    captionBox.style.display = 'block';

                    const caption =
                        (data && (data.caption || data.text || data.captionText)) ||
                        'Marketing text is being generated...';

                    captionText.value = caption;
                    showStatus(status, '‚úì Caption ready', 'success');
                    document.getElementById('finalTelegram').disabled = false;
                }
            } catch (err) {
                showStatus(status, '‚úó Network error: ' + err.message, 'error');
            }
            captionBtn.disabled = false;
        }

        async function sendToTelegram() {
            if (!selectedProduct) return;
            const status = document.getElementById('step2Status');
            showStatus(status, 'üöÄ Sending to Telegram...');
            telegramBtn.disabled = true;

            // Format scene as 'Category - Scene Name' instead of comma-separated
            const formattedScene = selectedScene.includes(',') 
                ? selectedScene.replace(',', ' - ') 
                : selectedScene;

            // Ensure Alma's reference image URL is correct
            let modelUrl = selectedProduct.modelUrl;
            if (selectedModel === 'Alma') {
                modelUrl = 'https://res.cloudinary.com/dtapjwtqw/image/upload/v1769810294/liranhe_Glamorous_portrait_of_a_captivating_woman_with_exotic_f_90e9b0f9-f99e-4553-9a00-cc7f73a3c494_f7ffkh.png';
            }

            const payload = {
                source: 'Web_App',
                product_id: selectedProduct.id,
                rowNumber: selectedProduct.rowNumber,
                product: selectedProduct.title,
                model: selectedModel,
                collection: selectedProduct.collection,
                model_url: modelUrl,
                scene: formattedScene,
                situation: formattedScene, // Add situation field with formatted value
                command: 'Approve & Post'
            };

            try {
                const res = await fetch(WEBHOOK_CAPTION, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (res.ok) { showStatus(status, '‚úì Sent to Telegram!', 'success'); }
                else { showStatus(status, '‚úó Error sending to Telegram', 'error'); }
            } catch (err) { showStatus(status, '‚úó Network error: ' + err.message, 'error'); }
            telegramBtn.disabled = false;
        }

        init();
    </script>
</body>
</html>


